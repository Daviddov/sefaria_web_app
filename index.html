<!DOCTYPE html>
<html dir="rtl" lang="he">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×•×•×˜ ×¡×¤×¨×™× ××©×•×¤×¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Noto Color Emoji", "EnglishInHebrew Serif Font", "Cardo", "Taamey Frank", "adobe-garamond-pro", "Crimson Text", "Times New Roman", serif;
            direction: rtl;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-top: 4px solid #18345d;
        }

        .header h1 {
            color: #18345d;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .breadcrumb {
            background: linear-gradient(135deg, #18345d, #0d1d34);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(24, 52, 93, 0.3);
        }

        .nav-buttons {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #18345d, #3498db);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-title {
            font-weight: bold;
            color: #18345d;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .card-subtitle {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .book-card {
            border-right: 4px solid #18345d;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #18345d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #18345d;
            font-size: 1.2em;
            font-weight: 600;
        }

        .progress-bar {
            width: 300px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #18345d, #3498db);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .section h3 {
            margin-bottom: 20px;
            color: #18345d;
            font-size: 1.3em;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: white;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #18345d;
            box-shadow: 0 0 0 3px rgba(24, 52, 93, 0.1);
        }

        .checkbox-group {
            max-height: 250px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            background: #fafafa;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .checkbox-group label:hover {
            background-color: #f0f8ff;
        }

        .checkbox-group input {
            width: auto;
            margin-left: 10px;
            margin-bottom: 0;
        }

        .paragraph-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .generate-btn {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 18px 35px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .generate-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .debug-panel {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #34495e;
        }

        .hidden {
            display: none;
        }

        .error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .step {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .api-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #18345d;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .paragraph-selector {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›ï¸ × ×™×•×•×˜ ×¡×¤×¨×™×</h1>
            <p>× ×•×•×˜ ×‘×¡×¤×¨×™ ×”×§×•×“×© ×‘×¦×•×¨×” ×—×›××” ×•×™×¦× ××¡××›×™× ××§×¦×•×¢×™×™×</p>
        </div>

        <!-- ×©×œ×‘ 1: × ×™×•×•×˜ ×œ×§×˜×’×•×¨×™×•×ª -->
        <div id="categoriesStep" class="step">
            <div class="breadcrumb" id="breadcrumb">ğŸ“ ×“×£ ×”×‘×™×ª</div>
            <div class="api-status hidden" id="apiStatus">
                <span class="status-dot"></span>
                <span class="status-text">××ª×—×‘×¨ ×œ×¡×¤×¨×™×...</span>
            </div>

            <div class="nav-buttons">
                <button class="btn" id="backBtn" disabled>ğŸ”™ ×—×–×•×¨</button>
                <button class="btn" id="homeBtn">ğŸ  ×“×£ ×”×‘×™×ª</button>
            </div>

            <div id="contentArea">
                <div class="loading">×˜×•×¢×Ÿ ×§×˜×’×•×¨×™×•×ª...</div>
            </div>
        </div>

        <!-- ×©×œ×‘ 2: ×‘×—×™×¨×ª section -->
        <div id="sectionStep" class="step hidden">
            <div class="breadcrumb" id="sectionBreadcrumb">ğŸ“ ×‘×—×™×¨×ª ×—×œ×§</div>

            <div class="nav-buttons">
                <button class="btn" id="backToBookFromSectionBtn">ğŸ”™ ×—×–×•×¨ ×œ×¡×¤×¨</button>
                <button class="btn" id="homeFromSectionBtn">ğŸ  ×“×£ ×”×‘×™×ª</button>
            </div>

            <div class="section">
                <h3>ğŸ“– ×¡×¤×¨ × ×‘×—×¨: <span id="selectedBookTitleSection"></span></h3>
                <h3>ğŸ“‘ ×‘×—×¨ ×—×œ×§:</h3>
                <select id="sectionSelect">
                    <option value="">×‘×—×¨ ×—×œ×§...</option>
                </select>
            </div>
        </div>

        <!-- ×©×œ×‘ 3: ×‘×—×™×¨×ª ×¤×¨×§ -->
        <div id="chapterStep" class="step hidden">
            <div class="breadcrumb" id="chapterBreadcrumb">ğŸ“ ×‘×—×™×¨×ª ×¤×¨×§</div>

            <div class="nav-buttons">
                <button class="btn" id="backToSectionBtn">ğŸ”™ ×—×–×•×¨ ×œ×—×œ×§</button>
                <button class="btn" id="backToBookBtn">ğŸ”™ ×—×–×•×¨ ×œ×¡×¤×¨</button>
                <button class="btn" id="homeFromChapterBtn">ğŸ  ×“×£ ×”×‘×™×ª</button>
            </div>

            <div class="section">
                <h3>ğŸ“– × ×‘×—×¨: <span id="selectedBookTitle"></span></h3>
                <h3 id="selectedSectionTitle" class="hidden">ğŸ“‘ ×—×œ×§: <span id="selectedSectionName"></span></h3>
                <h3>ğŸ”¢ ×‘×—×¨ ×¤×¨×§:</h3>
                <select id="chapterSelect">
                    <option value="">×‘×—×¨ ×¤×¨×§...</option>
                </select>
            </div>
        </div>

        <!-- ×©×œ×‘ 4: ×‘×—×™×¨×ª ×¤×™×¡×§××•×ª ×•×’×™×¨×¡××•×ª -->
        <div id="paragraphStep" class="step hidden">
            <div class="breadcrumb" id="paragraphBreadcrumb">ğŸ“ ×‘×—×™×¨×ª ×¤×™×¡×§××•×ª</div>

            <div class="nav-buttons">
                <button class="btn" id="backToChapterBtn">ğŸ”™ ×—×–×•×¨ ×œ×¤×¨×§</button>
                <button class="btn" id="homeFromParagraphBtn">ğŸ  ×“×£ ×”×‘×™×ª</button>
            </div>

            <div class="stats-container" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-number" id="totalVerses">-</div>
                    <div class="stat-label">×¤×¡×•×§×™× ×–××™× ×™×</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="selectedRange">-</div>
                    <div class="stat-label">×¤×¡×•×§×™× × ×‘×—×¨×™×</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="commentariesCount">-</div>
                    <div class="stat-label">××¤×¨×©×™× ×–××™× ×™×</div>
                </div>
            </div>

            <div class="section">
                <h3>ğŸ“„ ×¤×¨×§ × ×‘×—×¨: <span id="selectedChapterTitle"></span></h3>

                <div class="paragraph-selector">
                    <div>
                        <label>×¤×¡×•×§ ×”×ª×—×œ×”:</label>
                        <select id="startParagraph">
                            <option value="">×‘×—×¨ ×”×ª×—×œ×”...</option>
                        </select>
                    </div>
                    <div>
                        <label>×¤×¡×•×§ ×¡×•×£:</label>
                        <select id="endParagraph">
                            <option value="">×‘×—×¨ ×¡×•×£...</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>ğŸ“š ×’×™×¨×¡××•×ª × ×•×¡×¤×•×ª:</h3>
                <div id="versionsContainer" class="checkbox-group">
                    <div>×‘×—×¨ ×¤×¡×•×§×™× ×ª×—×™×œ×”</div>
                </div>
            </div>

            <div class="section">
                <h3>ğŸ“ ××¤×¨×©×™×:</h3>
                <div id="commentariesContainer" class="checkbox-group">
                    <div>×‘×—×¨ ×¤×¡×•×§×™× ×ª×—×™×œ×”</div>
                </div>
            </div>

            <button class="generate-btn" id="generateBtn" disabled>ğŸ“„ ×™×¦×•×¨ ××¡××š ××§×¦×•×¢×™</button>
        </div>

        <!-- ×¤×× ×œ ×“×™×‘×•×’ -->
        <div class="section">
            <h3>ğŸ”§ ××™×“×¢ ×˜×›× ×™:</h3>
            <button class="btn" id="clearDebugBtn">ğŸ—‘ï¸ × ×§×” ×œ×•×’</button>
            <div class="debug-panel" id="debugPanel">
                <div>ğŸ“± ××¤×œ×™×§×¦×™×” ××•×¤×¢×œ×ª</div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <script>
        class SefariaNavigator {
            constructor() {
                this.baseUrl = 'https://www.sefaria.org/api';
                this.currentPath = [];
                this.currentBook = null;
                this.currentSection = null;
                this.currentChapter = null;
                this.bookData = null;
                this.chapterData = null;
                this.commentaryCache = new Map();
                this.versionCache = new Map();
                this.apiStats = {
                    totalCalls: 0,
                    successCalls: 0,
                    failedCalls: 0,
                    cacheHits: 0
                };
                
                this.init();
            }

            init() {
                this.log('ğŸš€ ××ª×—×™×œ × ×™×•×•×˜ ×¡×¤×¨×™× ××©×•×¤×¨...');
                this.setupEventListeners();
                this.loadCategories();
                this.updateApiStatus('××ª×—×‘×¨ ×œ×¡×¤×¨×™×...', 'loading');
            }

            setupEventListeners() {
                // × ×™×•×•×˜
                document.getElementById('backBtn').addEventListener('click', () => this.goBack());
                document.getElementById('homeBtn').addEventListener('click', () => this.goHome());
                document.getElementById('backToBookFromSectionBtn').addEventListener('click', () => this.backToBook());
                document.getElementById('homeFromSectionBtn').addEventListener('click', () => this.goHome());
                document.getElementById('backToSectionBtn').addEventListener('click', () => this.backToSection());
                document.getElementById('backToBookBtn').addEventListener('click', () => this.backToBook());
                document.getElementById('homeFromChapterBtn').addEventListener('click', () => this.goHome());
                document.getElementById('backToChapterBtn').addEventListener('click', () => this.backToChapter());
                document.getElementById('homeFromParagraphBtn').addEventListener('click', () => this.goHome());

                // ×‘×—×™×¨×•×ª
                document.getElementById('sectionSelect').addEventListener('change', () => this.onSectionSelect());
                document.getElementById('chapterSelect').addEventListener('change', () => this.onChapterSelect());
                document.getElementById('startParagraph').addEventListener('change', () => this.onParagraphRangeChange());
                document.getElementById('endParagraph').addEventListener('change', () => this.onParagraphRangeChange());

                // ×™×¦×™×¨×ª ××¡××š
                document.getElementById('generateBtn').addEventListener('click', () => this.generateDocument());

                // ×“×™×‘×•×’
                document.getElementById('clearDebugBtn').addEventListener('click', () => this.clearDebug());
            }

            showLoading(text = '×˜×•×¢×Ÿ × ×ª×•× ×™×...', progress = 0) {
                const overlay = document.getElementById('loadingOverlay');
                const loadingText = document.getElementById('loadingText');
                const progressFill = document.getElementById('progressFill');
                
                overlay.classList.remove('hidden');
                loadingText.textContent = text;
                progressFill.style.width = progress + '%';
            }

            hideLoading() {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }

            updateApiStatus(text, status = 'success') {
                const statusEl = document.getElementById('apiStatus');
                const statusText = statusEl.querySelector('.status-text');
                
                statusEl.className = `api-status ${status}`;
                statusEl.classList.remove('hidden');
                
                if (statusText) {
                    statusText.textContent = text;
                } else {
                    statusEl.innerHTML = `<span class="status-text">${text}</span>`;
                }
            }

            async makeApiCall(url, description = 'API call') {
                this.apiStats.totalCalls++;
                
                try {
                    this.log(`ğŸŒ ${description}: ${url}`);
                    const response = await fetch(url);
                    
                    if (response.ok) {
                        this.apiStats.successCalls++;
                        const data = await response.json();
                        this.log(`âœ… ${description} ×”×•×©×œ× ×‘×”×¦×œ×—×”`);
                        return data;
                    } else {
                        this.apiStats.failedCalls++;
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    this.apiStats.failedCalls++;
                    this.log(`âŒ ×©×’×™××” ×‘-${description}: ${error.message}`, null, 'error');
                    throw error;
                }
            }

            getCacheKey(...parts) {
                return parts.join('_');
            }

            async loadCategories() {
                try {
                    this.showLoading('×˜×•×¢×Ÿ ×§×˜×’×•×¨×™×•×ª...', 10);
                    this.updateApiStatus('×˜×•×¢×Ÿ ×§×˜×’×•×¨×™×•×ª...', 'loading');
                    
                    const data = await this.makeApiCall(`${this.baseUrl}/index`, '×˜×¢×™× ×ª ×§×˜×’×•×¨×™×•×ª');
                    
                    this.showLoading('××¢×‘×“ ×§×˜×’×•×¨×™×•×ª...', 50);
                    this.displayCategories(data);
                    
                    this.updateApiStatus('××—×•×‘×¨ ×œ×¡×¤×¨×™× âœ“', 'success');
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    this.updateApiStatus('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×¡×¤×¨×™×', 'error');
                    this.showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×˜×’×•×¨×™×•×ª');
                }
            }

            displayCategories(categories) {
                const contentArea = document.getElementById('contentArea');
                contentArea.innerHTML = '';

                if (!Array.isArray(categories)) {
                    this.log('âŒ ×”×§×˜×’×•×¨×™×•×ª ××™× ×Ÿ ××¢×¨×š:', categories, 'error');
                    return;
                }

                const grid = document.createElement('div');
                grid.className = 'grid';

                categories.forEach(category => {
                    if (category.category) {
                        const card = this.createCard(
                            category.category,
                            category.heCategory || '',
                            () => this.navigateToCategory(category)
                        );
                        grid.appendChild(card);
                    }
                });

                contentArea.appendChild(grid);
                this.updateBreadcrumb();
            }

            async navigateToCategory(category) {
                try {
                    this.showLoading(`×˜×•×¢×Ÿ ${category.heCategory || category.category}...`, 20);
                    this.log(`ğŸ” × ×•×•×˜ ×œ×§×˜×’×•×¨×™×”: ${category.category}`);
                    this.currentPath.push(category);

                    if (category.contents) {
                        this.displayContents(category.contents);
                    } else {
                        const data = await this.makeApiCall(
                            `${this.baseUrl}/index/${encodeURIComponent(category.category)}`,
                            `×˜×¢×™× ×ª ×§×˜×’×•×¨×™×” ${category.category}`
                        );
                        this.displayContents(data.contents || []);
                    }

                    this.updateBreadcrumb();
                    this.updateBackButton();
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    this.showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×˜×’×•×¨×™×”');
                }
            }

            displayContents(contents) {
                const contentArea = document.getElementById('contentArea');
                contentArea.innerHTML = '';

                if (!Array.isArray(contents)) {
                    this.log('âŒ ×”×ª×•×›×Ÿ ××™× ×• ××¢×¨×š:', contents, 'error');
                    return;
                }

                const grid = document.createElement('div');
                grid.className = 'grid';

                contents.forEach(item => {
                    if (item.category) {
                        const card = this.createCard(
                            item.category,
                            item.heCategory || '',
                            () => this.navigateToCategory(item)
                        );
                        grid.appendChild(card);
                    } else if (item.title) {
                        const card = this.createCard(
                            item.title,
                            item.heTitle || '',
                            () => this.selectBook(item)
                        );
                        card.classList.add('book-card');
                        grid.appendChild(card);
                    }
                });

                contentArea.appendChild(grid);
            }

            createCard(title, subtitle, onClick) {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = onClick;

                const titleEl = document.createElement('div');
                titleEl.className = 'card-title';
                titleEl.textContent = subtitle;

                const subtitleEl = document.createElement('div');
                subtitleEl.className = 'card-subtitle';
                subtitleEl.textContent = title;

                card.appendChild(titleEl);
                card.appendChild(subtitleEl);

                return card;
            }

            async selectBook(book) {
                try {
                    this.showLoading(`×˜×•×¢×Ÿ ×¡×¤×¨ ${book.heTitle || book.title}...`, 30);
                    this.log(`ğŸ“– × ×‘×—×¨ ×¡×¤×¨: ${book.title}`);
                    this.currentBook = book;
                    
                    this.commentaryCache.clear();
                    this.versionCache.clear();
                    this.log('ğŸ§¹ × ×™×§×” cache');

                    this.bookData = await this.makeApiCall(
                        `${this.baseUrl}/v2/raw/index/${encodeURIComponent(book.title)}`,
                        `×˜×¢×™× ×ª ××™×“×¢ ×¡×¤×¨ ${book.title}`
                    );

                    if (this.bookData.schema && this.bookData.schema.nodes && this.bookData.schema.nodes.length > 0) {
                        this.log(`ğŸ“š ×¡×¤×¨ ××•×¨×›×‘ ×¢× ${this.bookData.schema.nodes.length} ×—×œ×§×™×`);
                        this.showSectionStep();
                    } else {
                        this.log('ğŸ“– ×¡×¤×¨ ×¤×©×•×˜');
                        this.showChapterStep();
                        this.populateChapters();
                    }
                    
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    this.showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¡×¤×¨');
                }
            }

            showSectionStep() {
                document.getElementById('categoriesStep').classList.add('hidden');
                document.getElementById('sectionStep').classList.remove('hidden');
                document.getElementById('selectedBookTitleSection').textContent = this.currentBook.heTitle || this.currentBook.title;
                this.populateSections();
            }

            populateSections() {
                const sectionSelect = document.getElementById('sectionSelect');
                sectionSelect.innerHTML = '<option value="">×‘×—×¨ ×—×œ×§...</option>';

                if (this.bookData.schema && this.bookData.schema.nodes) {
                    this.bookData.schema.nodes.forEach((section, index) => {
                        const option = document.createElement('option');
                        option.value = section.key || section.title;
                        option.textContent = section.titles[1].text || section.title;
                        option.dataset.index = index;
                        sectionSelect.appendChild(option);
                    });
                    this.log(`ğŸ“‘ ×”×•×¡×£ ${this.bookData.schema.nodes.length} ×—×œ×§×™×`);
                }
            }

            async onSectionSelect() {
                const sectionSelect = document.getElementById('sectionSelect');
                const selectedOption = sectionSelect.options[sectionSelect.selectedIndex];

                if (!selectedOption.value) return;

                this.currentSection = {
                    key: selectedOption.value,
                    index: parseInt(selectedOption.dataset.index),
                    title: selectedOption.textContent,
                    data: this.bookData.schema.nodes[selectedOption.dataset.index],
                };

                this.log(`ğŸ“‘ × ×‘×—×¨ ×—×œ×§: ${this.currentSection.title}`, this.currentSection);
                this.showChapterStep();
                this.populateChaptersForSection();
            }

            populateChaptersForSection() {
                const chapterSelect = document.getElementById('chapterSelect');
                chapterSelect.innerHTML = '<option value="">×‘×—×¨ ×¤×¨×§...</option>';

                const sectionData = this.currentSection.data;

                if (sectionData.index_offsets_by_depth && sectionData.index_offsets_by_depth["2"]) {
                    const offsets = sectionData.index_offsets_by_depth["2"];
                    const numChapters = offsets.length;

                    this.log(`ğŸ“– ×œ×—×œ×§ ×™×© ${numChapters} ×¤×¨×§×™×`);

                    for (let i = 1; i <= numChapters; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `×¤×¨×§ ${i}`;
                        chapterSelect.appendChild(option);
                    }

                    document.getElementById('selectedSectionTitle').classList.remove('hidden');
                    document.getElementById('selectedSectionName').textContent = this.currentSection.title;
                } else {
                    this.log('âŒ ×œ× × ××¦× ××™×“×¢ ×¤×¨×§×™× ×œ×—×œ×§', 'error');
                }
            }

            showChapterStep() {
                document.getElementById('categoriesStep').classList.add('hidden');
                document.getElementById('sectionStep').classList.add('hidden');
                document.getElementById('chapterStep').classList.remove('hidden');
                document.getElementById('selectedBookTitle').textContent = this.currentBook.heTitle || this.currentBook.title;

                if (this.currentSection) {
                    document.getElementById('selectedSectionTitle').classList.remove('hidden');
                    document.getElementById('selectedSectionName').textContent = this.currentSection.title;
                    document.getElementById('backToSectionBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('selectedSectionTitle').classList.add('hidden');
                    document.getElementById('backToSectionBtn').style.display = 'none';
                }
            }

            populateChapters() {
                const chapterSelect = document.getElementById('chapterSelect');
                chapterSelect.innerHTML = '<option value="">×‘×—×¨ ×¤×¨×§...</option>';

                let chapterCount = 0;
                
                this.log('ğŸ“Š ××‘× ×” ×¡×¤×¨:', this.bookData);
                
                if (this.bookData.schema && this.bookData.schema.lengths && this.bookData.schema.lengths.length > 0) {
                    chapterCount = this.bookData.schema.lengths[0];
                    this.log(`ğŸ“š ××©×ª××© ×‘-schema.lengths: ${chapterCount} ×¤×¨×§×™×`);
                } else if (this.bookData.schema && this.bookData.schema.content_counts && this.bookData.schema.content_counts.length > 0) {
                    chapterCount = this.bookData.schema.content_counts.length;
                    this.log(`ğŸ“š ××©×ª××© ×‘-schema.content_counts: ${chapterCount} ×¤×¨×§×™×`);
                } else if (this.bookData.lengths && this.bookData.lengths.length > 0) {
                    chapterCount = this.bookData.lengths[0];
                    this.log(`ğŸ“š ××©×ª××© ×‘-book.lengths: ${chapterCount} ×¤×¨×§×™×`);
                } else {
                    chapterCount = 50;
                    this.log(`ğŸ“š ××©×ª××© ×‘××¡×¤×¨ ×‘×¨×™×¨×ª ××—×“×œ: ${chapterCount}`);
                }
                
                for (let i = 1; i <= chapterCount; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `×¤×¨×§ ${i}`;
                    chapterSelect.appendChild(option);
                }
                
                this.log(`ğŸ“š ×”×•×¡×£ ${chapterCount} ×¤×¨×§×™× ×œ×× ×•`);
            }

            async onChapterSelect() {
                const chapterNum = document.getElementById('chapterSelect').value;
                if (!chapterNum) return;

                try {
                    this.showLoading(`×˜×•×¢×Ÿ ×¤×¨×§ ${chapterNum}...`, 40);
                    this.log(`ğŸ“„ ×˜×•×¢×Ÿ ×¤×¨×§ ${chapterNum}`);
                    this.currentChapter = chapterNum;

                    let chapterRef;
                    if (this.currentSection) {
                        chapterRef = `${this.currentBook.title}, ${this.currentSection.key} ${chapterNum}`;
                    } else {
                        chapterRef = `${this.currentBook.title} ${chapterNum}`;
                    }

                    this.log(`ğŸ”— ×”×¤× ×™×™×ª ×¤×¨×§: ${chapterRef}`);

                    // ×©×œ×™×¤×ª ××™×“×¢ ×”×¤×¨×§ ×‘×¦×•×¨×” ×××•×¤×˜×™××œ×ª
                    await this.loadChapterDataOptimized(chapterRef);

                    this.showParagraphStep();
                    this.populateParagraphs();
                    this.updateStats();
                    
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    this.showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¤×¨×§');
                }
            }

            async loadChapterDataOptimized(chapterRef) {
                const cacheKey = this.getCacheKey('chapter', chapterRef);
                
                if (this.versionCache.has(cacheKey)) {
                    this.apiStats.cacheHits++;
                    this.chapterData = this.versionCache.get(cacheKey);
                    this.log('ğŸ“‹ ××©×ª××© ×‘× ×ª×•× ×™ ×¤×¨×§ ××”×–×™×›×¨×•×Ÿ');
                    return;
                }

                try {
                    this.chapterData = await this.makeApiCall(
                        `${this.baseUrl}/texts/${encodeURIComponent(chapterRef)}`,
                        `×˜×¢×™× ×ª ×¤×¨×§ ${chapterRef}`
                    );

                    if (this.chapterData.he && Array.isArray(this.chapterData.he)) {
                        this.versionCache.set(cacheKey, this.chapterData);
                        this.log(`âœ… ×˜×¢×Ÿ ${this.chapterData.he.length} ×¤×¡×•×§×™×`);
                    } else {
                        throw new Error('×¤×•×¨××˜ ×¤×¨×§ ×œ× ×¦×¤×•×™');
                    }
                } catch (error) {
                    this.log(`âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×§: ${error.message}`, null, 'error');
                    throw error;
                }
            }

            showParagraphStep() {
                document.getElementById('chapterStep').classList.add('hidden');
                document.getElementById('paragraphStep').classList.remove('hidden');

                let title = `${this.currentBook.heTitle || this.currentBook.title}`;
                if (this.currentSection) {
                    title += `, ${this.currentSection.title}`;
                }
                title += ` ×¤×¨×§ ${this.currentChapter}`;

                document.getElementById('selectedChapterTitle').textContent = title;
            }

            populateParagraphs() {
                const startSelect = document.getElementById('startParagraph');
                const endSelect = document.getElementById('endParagraph');
                
                startSelect.innerHTML = '<option value="">×‘×—×¨ ×”×ª×—×œ×”...</option>';
                endSelect.innerHTML = '<option value="">×‘×—×¨ ×¡×•×£...</option>';

                if (this.chapterData.he && Array.isArray(this.chapterData.he)) {
                    const numParagraphs = this.chapterData.he.length;
                    this.log(`ğŸ“ ×¤×¨×§ ×›×•×œ×œ ${numParagraphs} ×¤×¡×•×§×™×`);

                    for (let i = 1; i <= numParagraphs; i++) {
                        const startOption = document.createElement('option');
                        startOption.value = i;
                        startOption.textContent = `×¤×¡×•×§ ${i}`;
                        startSelect.appendChild(startOption);

                        const endOption = document.createElement('option');
                        endOption.value = i;
                        endOption.textContent = `×¤×¡×•×§ ${i}`;
                        endSelect.appendChild(endOption);
                    }
                } else {
                    this.log('âŒ ×œ× × ××¦××• × ×ª×•× ×™ ×¤×¡×•×§×™×', 'error');
                }
            }

            updateStats() {
                const totalVerses = this.chapterData.he ? this.chapterData.he.length : 0;
                document.getElementById('totalVerses').textContent = totalVerses;
                
                const selectedRange = this.getSelectedRange();
                document.getElementById('selectedRange').textContent = selectedRange;
                
                // × ×¢×“×›×Ÿ ××ª ××¡×¤×¨ ×”××¤×¨×©×™× ×›××©×¨ × ×˜×¢×Ÿ ××•×ª×
                document.getElementById('commentariesCount').textContent = '-';
            }

            getSelectedRange() {
                const start = document.getElementById('startParagraph').value;
                const end = document.getElementById('endParagraph').value;
                
                if (start && end) {
                    return Math.abs(parseInt(end) - parseInt(start)) + 1;
                }
                return '-';
            }

            async onParagraphRangeChange() {
                const start = document.getElementById('startParagraph').value;
                const end = document.getElementById('endParagraph').value;

                this.updateStats();

                if (start && end) {
                    this.log(`ğŸ“ × ×‘×—×¨ ×˜×•×•×—: ${start} ×¢×“ ${end}`);

                    try {
                        this.showLoading('×˜×•×¢×Ÿ ×’×™×¨×¡××•×ª ×•××¤×¨×©×™×...', 60);
                        
                        await Promise.all([
                            this.loadVersionsOptimized(),
                            this.loadCommentariesOptimized()
                        ]);

                        document.getElementById('generateBtn').disabled = false;
                        this.hideLoading();
                    } catch (error) {
                        this.hideLoading();
                        this.log('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×’×™×¨×¡××•×ª ××• ××¤×¨×©×™×', null, 'error');
                    }
                } else {
                    document.getElementById('generateBtn').disabled = true;
                }
            }

            async loadVersionsOptimized() {
                try {
                    const cacheKey = this.getCacheKey('versions', this.currentBook.title);
                    
                    let versions;
                    if (this.versionCache.has(cacheKey)) {
                        this.apiStats.cacheHits++;
                        versions = this.versionCache.get(cacheKey);
                        this.log('ğŸ“‹ ××©×ª××© ×‘×’×™×¨×¡××•×ª ××”×–×™×›×¨×•×Ÿ');
                    } else {
                        versions = await this.makeApiCall(
                            `${this.baseUrl}/texts/versions/${encodeURIComponent(this.currentBook.title)}`,
                            '×˜×¢×™× ×ª ×’×™×¨×¡××•×ª'
                        );
                        this.versionCache.set(cacheKey, versions);
                    }

                    const container = document.getElementById('versionsContainer');
                    container.innerHTML = '';

                    if (Array.isArray(versions)) {
                        let addedVersions = 0;
                        versions.forEach(version => {
                            if (version.languageFamilyName !== 'hebrew' || !version.isPrimary) {
                                const label = document.createElement('label');
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.value = version.versionTitle;
                                checkbox.dataset.language = version.languageFamilyName;
                                checkbox.dataset.title = version.versionTitle;

                                label.appendChild(checkbox);
                                label.appendChild(document.createTextNode(`${version.versionTitle} (${version.languageFamilyName})`));
                                container.appendChild(label);
                                addedVersions++;
                            }
                        });
                        this.log(`ğŸ“š ×”×•×¡×£ ${addedVersions} ×’×™×¨×¡××•×ª`);
                    }
                } catch (error) {
                    this.log(`âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×’×™×¨×¡××•×ª: ${error.message}`, null, 'error');
                    document.getElementById('versionsContainer').innerHTML = '<div>×©×’×™××” ×‘×˜×¢×™× ×ª ×’×™×¨×¡××•×ª</div>';
                }
            }

            async loadCommentariesOptimized() {
                try {
                    const start = document.getElementById('startParagraph').value;
                    if (!start) return;

                    let sampleRef;
                    if (this.currentSection) {
                        sampleRef = `${this.currentBook.title}, ${this.currentSection.key} ${this.currentChapter}:${start}`;
                    } else {
                        sampleRef = `${this.currentBook.title} ${this.currentChapter}:${start}`;
                    }

                    const cacheKey = this.getCacheKey('commentaries', sampleRef);
                    
                    let commentaries;
                    if (this.commentaryCache.has(cacheKey)) {
                        this.apiStats.cacheHits++;
                        commentaries = this.commentaryCache.get(cacheKey);
                        this.log('ğŸ“‹ ××©×ª××© ×‘××¤×¨×©×™× ××”×–×™×›×¨×•×Ÿ');
                    } else {
                        commentaries = await this.discoverCommentariesOptimized(sampleRef);
                        this.commentaryCache.set(cacheKey, commentaries);
                    }

                    const container = document.getElementById('commentariesContainer');
                    container.innerHTML = '';

                    if (commentaries.size > 0) {
                        commentaries.forEach(title => {
                            const label = document.createElement('label');
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.value = title;

                            label.appendChild(checkbox);
                            label.appendChild(document.createTextNode(title));
                            container.appendChild(label);
                        });

                        document.getElementById('commentariesCount').textContent = commentaries.size;
                        this.log(`âœ… × ××¦××• ${commentaries.size} ××¤×¨×©×™×`);
                    } else {
                        container.innerHTML = '<div>×œ× × ××¦××• ××¤×¨×©×™× ×–××™× ×™×</div>';
                        document.getElementById('commentariesCount').textContent = '0';
                    }
                } catch (error) {
                    this.log(`âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ××¤×¨×©×™×: ${error.message}`, null, 'error');
                    document.getElementById('commentariesContainer').innerHTML = '<div>×©×’×™××” ×‘×˜×¢×™× ×ª ××¤×¨×©×™×</div>';
                }
            }

            async discoverCommentariesOptimized(ref) {
                const commentaries = new Set();

                try {
                    const links = await this.makeApiCall(
                        `${this.baseUrl}/links/${encodeURIComponent(ref)}`,
                        '×˜×¢×™× ×ª ×§×™×©×•×¨×™× ×œ××¤×¨×©×™×'
                    );

                    if (Array.isArray(links)) {
                        links.forEach(link => {
                            if (link.category === 'Commentary' && link.collectiveTitle) {
                                const title = link.collectiveTitle.he || link.collectiveTitle.en;
                                if (title) {
                                    commentaries.add(title);
                                    this.log(`ğŸ“ × ××¦× ××¤×¨×©: ${title}`);
                                }
                            }
                        });
                    }
                } catch (error) {
                    this.log(`âŒ ×©×’×™××” ×‘×—×™×¤×•×© ××¤×¨×©×™×: ${error.message}`);
                }

                return commentaries;
            }

            async generateDocument() {
                try {
                    this.log('ğŸ“„ ××ª×—×™×œ ×™×¦×™×¨×ª ××¡××š...');
                    this.showLoading('××›×™×Ÿ ××¡××š ××§×¦×•×¢×™...', 70);
                    
                    document.getElementById('generateBtn').disabled = true;

                    const start = parseInt(document.getElementById('startParagraph').value);
                    const end = parseInt(document.getElementById('endParagraph').value);

                    const selectedVersions = Array.from(document.querySelectorAll('#versionsContainer input[type="checkbox"]:checked'))
                        .map(cb => ({
                            title: cb.dataset.title,
                            language: cb.dataset.language
                        }))
                        .filter(v => v.title && v.language);

                    const selectedCommentaries = Array.from(document.querySelectorAll('#commentariesContainer input:checked'))
                        .map(cb => cb.value);

                    this.log(`ğŸ“Š ×˜×•×•×— × ×‘×—×¨: ${start} ×¢×“ ${end}`);
                    this.log(`ğŸ“š ×’×™×¨×¡××•×ª × ×‘×—×¨×•×ª:`, selectedVersions);
                    this.log(`ğŸ“ ××¤×¨×©×™× × ×‘×—×¨×™×: ${selectedCommentaries.join(', ') || '×œ×œ×'}`);

                    this.showLoading('××•×¡×£ ×ª×•×›×Ÿ...', 80);
                    const documentData = await this.fetchDocumentDataOptimized(start, end, selectedVersions, selectedCommentaries);

                    this.showLoading('××™×™×¦×¨ ××¡××š Word...', 95);
                    this.createProfessionalWordDocument(documentData);

                    this.log('âœ… ××¡××š × ×•×¦×¨ ×‘×”×¦×œ×—×”!', null, 'success');
                    this.showSuccess('×”××¡××š × ×•×¦×¨ ×‘×”×¦×œ×—×”!');
                    this.hideLoading();

                } catch (error) {
                    this.log(`âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ××¡××š: ${error.message}`, null, 'error');
                    this.showError('×©×’×™××” ×‘×™×¦×™×¨×ª ×”××¡××š');
                    this.hideLoading();
                } finally {
                    document.getElementById('generateBtn').disabled = false;
                }
            }

            async fetchDocumentDataOptimized(startParagraph, endParagraph, selectedVersions, selectedCommentaries) {
                const documentData = [];
                const totalParagraphs = endParagraph - startParagraph + 1;
                let processedParagraphs = 0;

                this.log(`ğŸ“š ××¢×‘×“ ×¤×¡×•×§×™× ${startParagraph} ×¢×“ ${endParagraph}`);

                for (let verseNum = startParagraph; verseNum <= endParagraph; verseNum++) {
                    this.log(`ğŸ“„ ××¢×‘×“ ×¤×¡×•×§ ${verseNum}`);

                    const arrayIndex = verseNum - 1;
                    
                    if (arrayIndex < 0 || arrayIndex >= this.chapterData.he.length) {
                        this.log(`âš ï¸ ××™× ×“×§×¡ ×œ× ×ª×§×™×Ÿ ${arrayIndex} ×œ×¤×¡×•×§ ${verseNum}`);
                        continue;
                    }

                    const hebrewText = this.chapterData.he[arrayIndex];
                    
                    let paragraphRef;
                    if (this.currentSection) {
                        paragraphRef = `${this.currentBook.title}, ${this.currentSection.key} ${this.currentChapter}:${verseNum}`;
                    } else {
                        paragraphRef = `${this.currentBook.title} ${this.currentChapter}:${verseNum}`;
                    }
                    
                    this.log(`ğŸ”— ×”×¤× ×™×™×ª ×¤×¡×•×§: ${paragraphRef}`);
                    
                    try {
                        const cleanText = hebrewText.replace(/<[^>]*>/g, '').trim();

                        if (!cleanText) {
                            this.log(`âš ï¸ ×˜×§×¡×˜ ×¨×™×§ ×œ×¤×¡×•×§ ${verseNum}`);
                            continue;
                        }

                        // ×¢×“×›×•×Ÿ ××—×•×–×™ ×”×ª×§×“××•×ª
                        processedParagraphs++;
                        const progress = 80 + (processedParagraphs / totalParagraphs) * 15;
                        this.showLoading(`××¢×‘×“ ×¤×¡×•×§ ${verseNum}/${endParagraph}...`, progress);

                        const [commentaries, additionalVersions] = await Promise.all([
                            this.fetchCommentariesForParagraphOptimized(paragraphRef, selectedCommentaries),
                            this.fetchAdditionalVersionsOptimized(paragraphRef, selectedVersions, arrayIndex)
                        ]);

                        documentData.push({
                            paragraphNum: verseNum,
                            ref: paragraphRef,
                            hebrewText: cleanText,
                            additionalVersions,
                            commentaries
                        });

                        this.log(`âœ… ×”×•×¡×£ ×¤×¡×•×§ ${verseNum} ×¢× ${commentaries.length} ××¤×¨×©×™×`);

                    } catch (error) {
                        this.log(`âŒ ×©×’×™××” ×‘×¢×™×‘×•×“ ×¤×¡×•×§ ${verseNum}: ${error.message}`, null, 'error');
                    }

                    // ×”×©×”×™×” ×§×¦×¨×” ×‘×™×Ÿ ×‘×§×©×•×ª
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                this.log(`ğŸ‰ × ×ª×•× ×™ ××¡××š ××•×›× ×™×: ${documentData.length} ×¤×¡×•×§×™×`);
                return documentData;
            }

            async fetchCommentariesForParagraphOptimized(ref, selectedCommentaries) {
                if (selectedCommentaries.length === 0) return [];

                try {
                    this.log(`ğŸ“ ×©×•×œ×£ ××¤×¨×©×™× ×¢×‘×•×¨: ${ref}`);

                    const response = await fetch(`${this.baseUrl}/links/${encodeURIComponent(ref)}`);
                    const links = await response.json();

                    const commentaries = [];

                    if (Array.isArray(links)) {
                        for (const link of links) {
                            if (link.category === 'Commentary' && link.collectiveTitle) {
                                const commentaryTitle = link.collectiveTitle.he || link.collectiveTitle.en;

                                if (selectedCommentaries.includes(commentaryTitle)) {
                                    this.log(`ğŸ” ××¢×‘×“ ××¤×¨×©: ${commentaryTitle} -> ${link.sourceRef}`);

                                    // ×©×œ×•×£ ××ª ×˜×§×¡×˜ ×”×¤×™×¨×•×© ×‘××•×¤×Ÿ ×—×›× ×™×•×ª×¨
                                    const commentaryText = await this.fetchCommentaryTextSmart(link.sourceRef, ref);
                                    if (commentaryText) {
                                        commentaries.push({
                                            title: commentaryTitle,
                                            text: commentaryText,
                                            ref: link.sourceRef
                                        });
                                        this.log(`âœ… ×”×•×¡×£ ××¤×¨×©: ${commentaryTitle} (${commentaryText.length} ×ª×•×•×™×)`);
                                    }
                                }
                            }
                        }
                    }

                    return commentaries;
                } catch (error) {
                    this.log(`âŒ ×©×’×™××” ×‘×©×œ×™×¤×ª ××¤×¨×©×™× ×¢×‘×•×¨ ${ref}: ${error.message}`, null, 'error');
                    return [];
                }
            }

            async fetchCommentaryTextSmart(commentaryRef, originalRef) {
                try {
                    this.log(`ğŸ“– ×©×•×œ×£ ××¤×¨×© ×‘×¦×•×¨×” ×—×›××”: ${commentaryRef}`);

                    // ×¤×¨×§ ××ª ×”×”×¤× ×™×” ×œ×–×™×”×•×™ ×”×¤×™×¡×§× ×”×¡×¤×¦×™×¤×™×ª
                    const { baseRef, paragraphNum } = this.parseCommentaryRef(commentaryRef, originalRef);

                    this.log(`ğŸ” ×¤×•×¨×§: baseRef=${baseRef}, paragraphNum=${paragraphNum}`);

                    // ×©×œ×•×£ ××ª ×›×œ ×”×¤×™×¨×•×© (×”×“×£/×¤×¨×§) ×‘×‘×ª ××—×ª
                    const response = await fetch(`${this.baseUrl}/texts/${encodeURIComponent(baseRef)}`);
                    const data = await response.json();

                    this.log(`ğŸ“Š × ×ª×•× ×™ ××¤×¨×© ×¢×‘×•×¨ ${baseRef}:`, data);

                    // ×—×œ×¥ ××ª ×”×˜×§×¡×˜ ×”×¡×¤×¦×™×¤×™ ××”××¢×¨×š
                    let text = '';

                    if (data.he && Array.isArray(data.he) && paragraphNum !== null) {
                        // ×™×© ××¢×¨×š ×•×× ×—× ×• ×™×•×“×¢×™× ××™×–×” ×¤×™×¡×§×
                        const paragraphIndex = paragraphNum - 1;
                        if (paragraphIndex >= 0 && paragraphIndex < data.he.length) {
                            text = data.he[paragraphIndex];
                            this.log(`âœ… × ××¦× ×¤×¡×§×” ×¡×¤×¦×™×¤×™×ª ${paragraphNum}: ${text.substring(0, 100)}...`);
                        } else {
                            this.log(`âŒ ×¤×¡×§×” ${paragraphNum} ×œ× × ××¦××” ×‘××¢×¨×š ×©×œ ${data.he.length} ×¤×¨×™×˜×™×`);
                        }
                    } else if (data.he) {
                        // ×× ××™×Ÿ ××¢×¨×š ××• ×œ× ×™×•×“×¢×™× ××ª ×”××¡×¤×¨, ×§×— ××ª ×”×›×œ
                        if (Array.isArray(data.he)) {
                            text = data.he.join(' ');
                        } else {
                            text = data.he;
                        }
                        this.log(`ğŸ“„ ××©×ª××© ×‘×˜×§×¡×˜ ××¤×¨×© ××œ× (${text.length} ×ª×•×•×™×)`);
                    } else if (data.text) {
                        if (Array.isArray(data.text)) {
                            text = data.text.join(' ');
                        } else {
                            text = data.text;
                        }
                    }

                    // × ×§×” ××ª ×”×˜×§×¡×˜ ×-HTML tags
                    if (text) {
                        text = text.replace(/<[^>]*>/g, '').trim();
                    }

                    this.log(`ğŸ“ ×˜×§×¡×˜ ××¤×¨×© ×¡×•×¤×™ (${text.length} ×ª×•×•×™×): ${text.substring(0, 100)}...`);
                    return text;

                } catch (error) {
                    this.log(`âŒ ×©×’×™××” ×‘×©×œ×™×¤×ª ×˜×§×¡×˜ ××¤×¨×©: ${error.message}`, null, 'error');
                    return '';
                }
            }

            parseCommentaryRef(commentaryRef, originalRef) {
                // × ×¡×” ×œ×¤×¨×§ ××ª ×”×”×¤× ×™×” ×œ××¦×™××ª ×”×¤×™×¡×§× ×”×¨×œ×•×•× ×˜×™×ª
                try {
                    // ×“×•×’××: "Mikdash Melekh on Zohar 1:1a:1" -> baseRef="Mikdash Melekh on Zohar 1:1a", paragraphNum=1
                    const parts = commentaryRef.split(':');

                    if (parts.length >= 3) {
                        // ×™×© ××¡×¤×¨ ×¤×™×¡×§× ×‘××—×¨×•×Ÿ
                        const paragraphNum = parseInt(parts[parts.length - 1]);
                        const baseRef = parts.slice(0, -1).join(':');

                        if (!isNaN(paragraphNum)) {
                            return { baseRef, paragraphNum };
                        }
                    }

                    // ×× ×œ× ×”×¦×œ×—× ×• ×œ×¤×¨×§, × ×—×–×™×¨ ××ª ×›×œ ×”×”×¤× ×™×” ×›-baseRef
                    return { baseRef: commentaryRef, paragraphNum: null };

                } catch (error) {
                    this.log(`âŒ ×©×’×™××” ×‘×¤×™×¨×•×§ ×”×¤× ×™×™×ª ××¤×¨×©: ${error.message}`);
                    return { baseRef: commentaryRef, paragraphNum: null };
                }
            }

            async fetchAdditionalVersionsOptimized(ref, selectedVersions, arrayIndex) {
                if (!selectedVersions || selectedVersions.length === 0) {
                    return [];
                }

                const versions = [];

                for (const version of selectedVersions) {
                    try {
                        if (!version.title || !version.language) {
                            continue;
                        }
                        
                        const cacheKey = this.getCacheKey('version_chapter', this.currentChapter, version.title);
                        
                        let versionChapterData;
                        if (this.versionCache.has(cacheKey)) {
                            this.apiStats.cacheHits++;
                            versionChapterData = this.versionCache.get(cacheKey);
                        } else {
                            const chapterRef = ref.split(':')[0];
                            const versionParam = encodeURIComponent(`${version.language}|${version.title}`);
                            
                            versionChapterData = await this.makeApiCall(
                                `${this.baseUrl}/v3/texts/${encodeURIComponent(chapterRef)}?version=${versionParam}`,
                                `×˜×¢×™× ×ª ×’×™×¨×¡×” ${version.title} ×œ×¤×¨×§`
                            );
                            
                            this.versionCache.set(cacheKey, versionChapterData);
                        }
                        
                        let versionText = '';
                        if (versionChapterData.versions && versionChapterData.versions[0] && versionChapterData.versions[0].text) {
                            versionText = versionChapterData.versions[0].text[arrayIndex];
                        }
                        
                        if (versionText && versionText.trim()) {
                            versionText = versionText.replace(/<[^>]*>/g, '').trim();
                            
                            versions.push({
                                title: version.title,
                                language: version.language,
                                text: versionText
                            });
                        }
                        
                    } catch (error) {
                        this.log(`âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×’×™×¨×¡×” ${version.title}: ${error.message}`, null, 'error');
                    }
                }

                return versions;
            }

            createProfessionalWordDocument(documentData) {
                let html = `
                <!DOCTYPE html>
                <html dir="rtl" lang="he">
                <head>
                    <meta charset="UTF-8">
                    <style>
                        @page {
                            margin: 2cm;
                            direction: rtl;
                        }
                        
                        body { 
                            font-family: 'David', 'Frank Ruhl Libre', 'Times New Roman', serif; 
                            direction: rtl; 
                            text-align: right;
                            line-height: 1.8;
                            margin: 0;
                            color: #333;
                            font-size: 16px;
                        }
                        
                        .document-header { 
                            text-align: center; 
                            margin-bottom: 40px;
                            padding-bottom: 20px;
                            border-bottom: 3px solid #18345d;
                        }
                        
                        .main-title { 
                            font-size: 28px; 
                            font-weight: bold; 
                            color: #18345d;
                            margin-bottom: 10px;
                        }
                        
                        .subtitle {
                            font-size: 16px;
                            color: #666;
                            margin-bottom: 15px;
                        }
                        
                        .meta-info {
                            font-size: 14px;
                            color: #888;
                            font-style: italic;
                        }
                        
                        .verse-container { 
                            margin-bottom: 35px; 
                            padding: 20px;
                            background: #fafafa;
                            border-right: 4px solid #18345d;
                            border-radius: 8px;
                            page-break-inside: avoid;
                        }
                        
                        .verse-header { 
                            font-size: 16px; 
                            font-weight: bold; 
                            color: #18345d;
                            margin-bottom: 15px;
                            padding-bottom: 8px;
                            border-bottom: 1px solid #ddd;
                        }
                        
                        .verse-text { 
                            font-size: 18px; 
                            font-weight: 600; 
                            margin-bottom: 20px;
                            line-height: 1.8;
                            color: #222;
                            background: white;
                            padding: 15px;
                            border-radius: 6px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }
                        
                        .verse-number {
                            display: inline-block;
                            background: #18345d;
                            color: white;
                            font-size: 14px;
                            font-weight: bold;
                            padding: 4px 8px;
                            border-radius: 50%;
                            margin-left: 10px;
                            min-width: 24px;
                            text-align: center;
                        }
                        
                        .versions-section {
                            margin-top: 20px;
                            padding-top: 15px;
                            border-top: 2px dashed #ddd;
                        }
                        
                        .version-item {
                            margin: 15px 0;
                            padding: 15px;
                            background: white;
                            border-right: 3px solid #3498db;
                            border-radius: 6px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        }
                        
                        .version-title {
                            font-weight: bold;
                            color: #3498db;
                            margin-bottom: 8px;
                            font-size: 15px;
                        }
                        
                        .version-text {
                            font-size: 16px;
                            color: #444;
                            line-height: 1.6;
                        }
                        
                        .commentaries-section {
                            margin-top: 20px;
                            padding-top: 15px;
                            border-top: 2px dashed #ddd;
                        }
                        
                        .commentary-item {
                            margin: 15px 0;
                            padding: 15px;
                            background: white;
                            border-right: 3px solid #8e44ad;
                            border-radius: 6px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        }
                        
                        .commentary-title { 
                            font-size: 15px; 
                            font-weight: bold; 
                            color: #8e44ad;
                            margin-bottom: 8px;
                        }
                        
                        .commentary-text { 
                            font-size: 15px; 
                            color: #555;
                            line-height: 1.6;
                        }
                        
                        .section-divider {
                            text-align: center;
                            margin: 30px 0;
                            color: #999;
                            font-size: 24px;
                        }
                        
                        .footer {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 2px solid #18345d;
                            text-align: center;
                            color: #666;
                            font-size: 14px;
                        }
                        
                        @media print {
                            .verse-container {
                                break-inside: avoid;
                            }
                            
                            body {
                                font-size: 14px;
                            }
                            
                            .main-title {
                                font-size: 24px;
                            }
                        }
                    </style>
                </head>
                <body>
                `;

                // ×›×•×ª×¨×ª ×”××¡××š
                let title = this.currentBook.heTitle || this.currentBook.title;
                if (this.currentSection) {
                    title += ` - ${this.currentSection.title}`;
                }
                title += ` ×¤×¨×§ ${this.currentChapter}`;

                const start = documentData.length > 0 ? documentData[0].paragraphNum : '';
                const end = documentData.length > 0 ? documentData[documentData.length - 1].paragraphNum : '';
                const range = start && end ? (start === end ? `×¤×¡×•×§ ${start}` : `×¤×¡×•×§×™× ${start}-${end}`) : '';

                html += `
                <div class="document-header">
                    <div class="main-title">${title}</div>
                    <div class="subtitle">${range}</div>
                    <div class="meta-info">× ×•×¦×¨ ×‘×××¦×¢×•×ª × ×™×•×•×˜ ×¡×¤×¨×™× â€¢ ${new Date().toLocaleDateString('he-IL')}</div>
                </div>
                `;

                // ×ª×•×›×Ÿ ×”×¤×¡×•×§×™×
                documentData.forEach((verse, index) => {
                    html += `
                    <div class="verse-container">
                        <div class="verse-header">
                            <span class="verse-number">${verse.paragraphNum}</span>
                            ${verse.ref}
                        </div>
                        <div class="verse-text">${verse.hebrewText}</div>
                    `;

                    // ×’×™×¨×¡××•×ª × ×•×¡×¤×•×ª
                    if (verse.additionalVersions && verse.additionalVersions.length > 0) {
                        html += `<div class="versions-section">`;
                        verse.additionalVersions.forEach(version => {
                            html += `
                            <div class="version-item">
                                <div class="version-title">${version.title} (${version.language})</div>
                                <div class="version-text">${version.text}</div>
                            </div>
                            `;
                        });
                        html += `</div>`;
                    }

                    // ××¤×¨×©×™×
                    if (verse.commentaries && verse.commentaries.length > 0) {
                        html += `<div class="commentaries-section">`;
                        verse.commentaries.forEach(commentary => {
                            html += `
                            <div class="commentary-item">
                                <div class="commentary-title">${commentary.title}</div>
                                <div class="commentary-text">${commentary.text}</div>
                            </div>
                            `;
                        });
                        html += `</div>`;
                    }

                    html += `</div>`;

                    // ××¤×¨×™×“ ×‘×™×Ÿ ×¤×¡×•×§×™×
                    if (index < documentData.length - 1) {
                        html += `<div class="section-divider">â—†</div>`;
                    }
                });

                // ×›×•×ª×¨×ª ×ª×—×ª×•× ×”
                html += `
                <div class="footer">
                    <p>××¡××š ×–×” × ×•×¦×¨ ×‘×××¦×¢×•×ª × ×™×•×•×˜ ×¡×¤×¨×™×</p>
                    <p>××§×•×¨: ×¡×¤×¨×™× (sefaria.org) â€¢ ${documentData.length} ×¤×¡×•×§×™×</p>
                </div>
                `;

                html += `</body></html>`;

                // ×”×•×¨×“×ª ×”×§×•×‘×¥
                const blob = new Blob([html], { 
                    type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // ×™×¦×™×¨×ª ×©× ×§×•×‘×¥ × ×§×™
                const cleanTitle = title.replace(/[^\u0590-\u05FF\w\s-]/g, '').trim();
                a.download = `${cleanTitle}.doc`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.log(`ğŸ“„ ××¡××š ×”×•×¨×“: ${cleanTitle}.doc`);
            }

            // ×¤×•× ×§×¦×™×•×ª × ×™×•×•×˜
            goBack() {
                if (this.currentPath.length > 0) {
                    this.currentPath.pop();
                    if (this.currentPath.length === 0) {
                        this.loadCategories();
                    } else {
                        const parent = this.currentPath[this.currentPath.length - 1];
                        this.navigateToCategory(parent);
                        this.currentPath.pop();
                    }
                    this.updateBreadcrumb();
                    this.updateBackButton();
                }
            }

            goHome() {
                this.currentPath = [];
                this.currentBook = null;
                this.currentSection = null;
                this.currentChapter = null;

                document.getElementById('categoriesStep').classList.remove('hidden');
                document.getElementById('sectionStep').classList.add('hidden');
                document.getElementById('chapterStep').classList.add('hidden');
                document.getElementById('paragraphStep').classList.add('hidden');

                this.loadCategories();
                this.updateBreadcrumb();
                this.updateBackButton();

                this.log('ğŸ  ×—×–×¨×” ×œ×“×£ ×”×‘×™×ª');
            }

            backToBook() {
                this.currentSection = null;

                document.getElementById('sectionStep').classList.add('hidden');
                document.getElementById('chapterStep').classList.add('hidden');
                document.getElementById('paragraphStep').classList.add('hidden');
                document.getElementById('categoriesStep').classList.remove('hidden');

                this.log('ğŸ“– ×—×–×¨×” ×œ×‘×—×™×¨×ª ×¡×¤×¨');
            }

            backToSection() {
                document.getElementById('chapterStep').classList.add('hidden');
                document.getElementById('paragraphStep').classList.add('hidden');
                document.getElementById('sectionStep').classList.remove('hidden');

                this.log('ğŸ“‘ ×—×–×¨×” ×œ×‘×—×™×¨×ª ×—×œ×§');
            }

            backToChapter() {
                document.getElementById('paragraphStep').classList.add('hidden');
                document.getElementById('chapterStep').classList.remove('hidden');

                this.log('ğŸ”¢ ×—×–×¨×” ×œ×‘×—×™×¨×ª ×¤×¨×§');
            }

            updateBreadcrumb() {
                const breadcrumb = document.getElementById('breadcrumb');
                let path = 'ğŸ“ ×“×£ ×”×‘×™×ª';

                this.currentPath.forEach(item => {
                    if (item.category) {
                        path += ` > ${item.heCategory || item.category}`;
                    } else if (item.title) {
                        path += ` > ${item.heTitle || item.title}`;
                    }
                });

                breadcrumb.textContent = path;
            }

            updateBackButton() {
                document.getElementById('backBtn').disabled = this.currentPath.length === 0;
            }

            // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
            log(message, data = null, type = 'info') {
                const debugPanel = document.getElementById('debugPanel');
                const timestamp = new Date().toLocaleTimeString('he-IL');

                let logEntry = `[${timestamp}] ${message}`;
                if (data) {
                    logEntry += '\n' + JSON.stringify(data, null, 2);
                }

                const logDiv = document.createElement('div');
                logDiv.style.color = type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#3498db';
                logDiv.style.marginBottom = '5px';
                logDiv.style.borderBottom = '1px solid #444';
                logDiv.style.paddingBottom = '3px';
                logDiv.textContent = logEntry;

                debugPanel.appendChild(logDiv);
                debugPanel.scrollTop = debugPanel.scrollHeight;

                // ×”×’×‘×œ ××ª ××¡×¤×¨ ×”×”×•×“×¢×•×ª ×‘×œ×•×’
                while (debugPanel.children.length > 100) {
                    debugPanel.removeChild(debugPanel.firstChild);
                }

                console.log(message, data);
            }

            clearDebug() {
                const debugPanel = document.getElementById('debugPanel');
                debugPanel.innerHTML = '<div>ğŸ“± ×œ×•×’ × ×•×§×” â€¢ ×¡×˜×˜×™×¡×˜×™×§×•×ª API:</div>';
                
                // ×”×¦×’ ×¡×˜×˜×™×¡×˜×™×§×•×ª API
                const statsDiv = document.createElement('div');
                statsDiv.style.color = '#3498db';
                statsDiv.style.margin = '10px 0';
                statsDiv.innerHTML = `
                    ğŸ“Š ×¡×”"×› ×§×¨×™××•×ª: ${this.apiStats.totalCalls}<br>
                    âœ… ×”×¦×œ×™×—×•: ${this.apiStats.successCalls}<br>
                    âŒ × ×›×©×œ×•: ${this.apiStats.failedCalls}<br>
                    ğŸ“‹ ×©×™××•×© ×‘××˜××•×Ÿ: ${this.apiStats.cacheHits}
                `;
                debugPanel.appendChild(statsDiv);
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `
                    <strong>âŒ ×©×’×™××”:</strong> ${message}
                    <br><small>×‘×“×•×§ ××ª ×”×œ×•×’ ×œ××™×“×¢ × ×•×¡×£</small>
                `;
                document.body.appendChild(errorDiv);

                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 7000);
            }

            showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.innerHTML = `
                    <strong>âœ… ×”×¦×œ×—×”:</strong> ${message}
                `;
                document.body.appendChild(successDiv);

                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 5000);
            }
        }

        // ×”×ª×—×œ×ª ×”××¤×œ×™×§×¦×™×”
        document.addEventListener('DOMContentLoaded', () => {
            new SefariaNavigator();
        });
    </script>
</body>

</html>