<!DOCTYPE html>
<html dir="rtl" lang="he">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניווט ספריא משופר</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Frank Ruhl Libre', 'David', 'Times New Roman', serif;
            direction: rtl;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-top: 4px solid #18345d;
        }

        .header h1 {
            color: #18345d;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .breadcrumb {
            background: linear-gradient(135deg, #18345d, #0d1d34);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(24, 52, 93, 0.3);
        }

        .nav-buttons {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #18345d, #3498db);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-title {
            font-weight: bold;
            color: #18345d;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .card-subtitle {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .book-card {
            border-right: 4px solid #18345d;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #18345d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #18345d;
            font-size: 1.2em;
            font-weight: 600;
        }

        .progress-bar {
            width: 300px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #18345d, #3498db);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .section h3 {
            margin-bottom: 20px;
            color: #18345d;
            font-size: 1.3em;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: white;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #18345d;
            box-shadow: 0 0 0 3px rgba(24, 52, 93, 0.1);
        }

        .checkbox-group {
            max-height: 250px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            background: #fafafa;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .checkbox-group label:hover {
            background-color: #f0f8ff;
        }

        .checkbox-group input {
            width: auto;
            margin-left: 10px;
            margin-bottom: 0;
        }

        .paragraph-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .generate-btn {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 18px 35px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .generate-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .debug-panel {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #34495e;
        }

        .hidden {
            display: none;
        }

        .error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .step {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .api-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #18345d;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .paragraph-selector {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🏛️ ניווט ספריא</h1>
            <p>נווט בספרי הקודש בצורה חכמה ויצא מסמכים מקצועיים</p>
        </div>

        <!-- שלב 1: ניווט לקטגוריות -->
        <div id="categoriesStep" class="step">
            <div class="breadcrumb" id="breadcrumb">📍 דף הבית</div>
            <div class="api-status hidden" id="apiStatus">
                <span class="status-dot"></span>
                <span class="status-text">מתחבר לספריא...</span>
            </div>

            <div class="nav-buttons">
                <button class="btn" id="backBtn" disabled>🔙 חזור</button>
                <button class="btn" id="homeBtn">🏠 דף הבית</button>
            </div>

            <div id="contentArea">
                <div class="loading">טוען קטגוריות...</div>
            </div>
        </div>

        <!-- שלב 2: בחירת section -->
        <div id="sectionStep" class="step hidden">
            <div class="breadcrumb" id="sectionBreadcrumb">📍 בחירת חלק</div>

            <div class="nav-buttons">
                <button class="btn" id="backToBookFromSectionBtn">🔙 חזור לספר</button>
                <button class="btn" id="homeFromSectionBtn">🏠 דף הבית</button>
            </div>

            <div class="section">
                <h3>📖 ספר נבחר: <span id="selectedBookTitleSection"></span></h3>
                <h3>📑 בחר חלק:</h3>
                <select id="sectionSelect">
                    <option value="">בחר חלק...</option>
                </select>
            </div>
        </div>

        <!-- שלב 3: בחירת פרק -->
        <div id="chapterStep" class="step hidden">
            <div class="breadcrumb" id="chapterBreadcrumb">📍 בחירת פרק</div>

            <div class="nav-buttons">
                <button class="btn" id="backToSectionBtn">🔙 חזור לחלק</button>
                <button class="btn" id="backToBookBtn">🔙 חזור לספר</button>
                <button class="btn" id="homeFromChapterBtn">🏠 דף הבית</button>
            </div>

            <div class="section">
                <h3>📖 נבחר: <span id="selectedBookTitle"></span></h3>
                <h3 id="selectedSectionTitle" class="hidden">📑 חלק: <span id="selectedSectionName"></span></h3>
                <h3>🔢 בחר פרק:</h3>
                <select id="chapterSelect">
                    <option value="">בחר פרק...</option>
                </select>
            </div>
        </div>

        <!-- שלב 4: בחירת פיסקאות וגירסאות -->
        <div id="paragraphStep" class="step hidden">
            <div class="breadcrumb" id="paragraphBreadcrumb">📍 בחירת פיסקאות</div>

            <div class="nav-buttons">
                <button class="btn" id="backToChapterBtn">🔙 חזור לפרק</button>
                <button class="btn" id="homeFromParagraphBtn">🏠 דף הבית</button>
            </div>

            <div class="stats-container" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-number" id="totalVerses">-</div>
                    <div class="stat-label">פסוקים זמינים</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="selectedRange">-</div>
                    <div class="stat-label">פסוקים נבחרים</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="commentariesCount">-</div>
                    <div class="stat-label">מפרשים זמינים</div>
                </div>
            </div>

            <div class="section">
                <h3>📄 פרק נבחר: <span id="selectedChapterTitle"></span></h3>

                <div class="paragraph-selector">
                    <div>
                        <label>פסוק התחלה:</label>
                        <select id="startParagraph">
                            <option value="">בחר התחלה...</option>
                        </select>
                    </div>
                    <div>
                        <label>פסוק סוף:</label>
                        <select id="endParagraph">
                            <option value="">בחר סוף...</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>📚 גירסאות נוספות:</h3>
                <div id="versionsContainer" class="checkbox-group">
                    <div>בחר פסוקים תחילה</div>
                </div>
            </div>

            <div class="section">
                <h3>📝 מפרשים:</h3>
                <div id="commentariesContainer" class="checkbox-group">
                    <div>בחר פסוקים תחילה</div>
                </div>
            </div>

            <button class="generate-btn" id="generateBtn" disabled>📄 יצור מסמך מקצועי</button>
        </div>

        <!-- פאנל דיבוג -->
        <div class="section">
            <h3>🔧 מידע טכני:</h3>
            <button class="btn" id="clearDebugBtn">🗑️ נקה לוג</button>
            <div class="debug-panel" id="debugPanel">
                <div>📱 אפליקציה מופעלת</div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">טוען נתונים...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <script>
        class SefariaNavigator {
            constructor() {
                this.baseUrl = 'https://www.sefaria.org/api';
                this.currentPath = [];
                this.currentBook = null;
                this.currentSection = null;
                this.currentSubSection = null; // הוספה של רמת תת-חלק נוספת
                this.currentChapter = null;
                this.bookData = null;
                this.chapterData = null;
                this.commentaryCache = new Map();
                this.versionCache = new Map();
                this.apiStats = {
                    totalCalls: 0,
                    successCalls: 0,
                    failedCalls: 0,
                    cacheHits: 0
                };
                
                this.init();
            }

            init() {
                this.log('🚀 מתחיל ניווט ספריא משופר...');
                this.setupEventListeners();
                this.loadCategories();
                this.updateApiStatus('מתחבר לספריא...', 'loading');
            }

            setupEventListeners() {
                // ניווט
                document.getElementById('backBtn').addEventListener('click', () => this.goBack());
                document.getElementById('homeBtn').addEventListener('click', () => this.goHome());
                document.getElementById('backToBookFromSectionBtn').addEventListener('click', () => this.backToBook());
                document.getElementById('homeFromSectionBtn').addEventListener('click', () => this.goHome());
                document.getElementById('backToSectionBtn').addEventListener('click', () => this.backToSection());
                document.getElementById('backToBookBtn').addEventListener('click', () => this.backToBook());
                document.getElementById('homeFromChapterBtn').addEventListener('click', () => this.goHome());
                document.getElementById('backToChapterBtn').addEventListener('click', () => this.backToChapter());
                document.getElementById('homeFromParagraphBtn').addEventListener('click', () => this.goHome());

                // בחירות
                document.getElementById('sectionSelect').addEventListener('change', () => this.onSectionSelect());
                document.getElementById('chapterSelect').addEventListener('change', () => {
                    const selectedOption = document.getElementById('chapterSelect').options[document.getElementById('chapterSelect').selectedIndex];
                    if (selectedOption && selectedOption.dataset.isFinalPrayer === 'true') {
                        this.handleFinalPrayerSelection();
                    } else if (selectedOption && selectedOption.dataset.hasSubNodes === 'true') {
                        this.handleSubCategorySelection();
                    } else {
                        this.onChapterSelect();
                    }
                });
                document.getElementById('startParagraph').addEventListener('change', () => this.onParagraphRangeChange());
                document.getElementById('endParagraph').addEventListener('change', () => this.onParagraphRangeChange());

                // יצירת מסמך
                document.getElementById('generateBtn').addEventListener('click', () => this.generateDocument());

                // דיבוג
                document.getElementById('clearDebugBtn').addEventListener('click', () => this.clearDebug());
            }

            showLoading(text = 'טוען נתונים...', progress = 0) {
                const overlay = document.getElementById('loadingOverlay');
                const loadingText = document.getElementById('loadingText');
                const progressFill = document.getElementById('progressFill');
                
                overlay.classList.remove('hidden');
                loadingText.textContent = text;
                progressFill.style.width = progress + '%';
            }

            hideLoading() {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }

            updateApiStatus(text, status = 'success') {
                const statusEl = document.getElementById('apiStatus');
                const statusText = statusEl.querySelector('.status-text');
                
                statusEl.className = `api-status ${status}`;
                statusEl.classList.remove('hidden');
                
                if (statusText) {
                    statusText.textContent = text;
                } else {
                    statusEl.innerHTML = `<span class="status-text">${text}</span>`;
                }
            }

            async makeApiCall(url, description = 'API call') {
                this.apiStats.totalCalls++;
                
                try {
                    this.log(`🌐 ${description}: ${url}`);
                    const response = await fetch(url);
                    
                    if (response.ok) {
                        this.apiStats.successCalls++;
                        const data = await response.json();
                        this.log(`✅ ${description} הושלם בהצלחה`);
                        return data;
                    } else {
                        this.apiStats.failedCalls++;
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    this.apiStats.failedCalls++;
                    this.log(`❌ שגיאה ב-${description}: ${error.message}`, null, 'error');
                    throw error;
                }
            }

            getCacheKey(...parts) {
                return parts.join('_');
            }

            async loadCategories() {
                try {
                    this.showLoading('טוען קטגוריות...', 10);
                    this.updateApiStatus('טוען קטגוריות...', 'loading');
                    
                    const data = await this.makeApiCall(`${this.baseUrl}/index`, 'טעינת קטגוריות');
                    
                    this.showLoading('מעבד קטגוריות...', 50);
                    this.displayCategories(data);
                    
                    this.updateApiStatus('מחובר לספריא ✓', 'success');
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    this.updateApiStatus('שגיאה בחיבור לספריא', 'error');
                    this.showError('שגיאה בטעינת הקטגוריות');
                }
            }

            displayCategories(categories) {
                const contentArea = document.getElementById('contentArea');
                contentArea.innerHTML = '';

                if (!Array.isArray(categories)) {
                    this.log('❌ הקטגוריות אינן מערך:', categories, 'error');
                    return;
                }

                const grid = document.createElement('div');
                grid.className = 'grid';

                categories.forEach(category => {
                    if (category.category) {
                        const card = this.createCard(
                            category.category,
                            category.heCategory || '',
                            () => this.navigateToCategory(category)
                        );
                        grid.appendChild(card);
                    }
                });

                contentArea.appendChild(grid);
                this.updateBreadcrumb();
            }

            async navigateToCategory(category) {
                try {
                    this.showLoading(`טוען ${category.heCategory || category.category}...`, 20);
                    this.log(`🔍 נווט לקטגוריה: ${category.category}`);
                    this.currentPath.push(category);

                    if (category.contents) {
                        this.displayContents(category.contents);
                    } else {
                        const data = await this.makeApiCall(
                            `${this.baseUrl}/index/${encodeURIComponent(category.category)}`,
                            `טעינת קטגוריה ${category.category}`
                        );
                        this.displayContents(data.contents || []);
                    }

                    this.updateBreadcrumb();
                    this.updateBackButton();
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    this.showError('שגיאה בטעינת הקטגוריה');
                }
            }

            displayContents(contents) {
                const contentArea = document.getElementById('contentArea');
                contentArea.innerHTML = '';

                if (!Array.isArray(contents)) {
                    this.log('❌ התוכן אינו מערך:', contents, 'error');
                    return;
                }

                const grid = document.createElement('div');
                grid.className = 'grid';

                contents.forEach(item => {
                    if (item.category) {
                        const card = this.createCard(
                            item.category,
                            item.heCategory || '',
                            () => this.navigateToCategory(item)
                        );
                        grid.appendChild(card);
                    } else if (item.title) {
                        const card = this.createCard(
                            item.title,
                            item.heTitle || '',
                            () => this.selectBook(item)
                        );
                        card.classList.add('book-card');
                        grid.appendChild(card);
                    }
                });

                contentArea.appendChild(grid);
            }

            createCard(title, subtitle, onClick) {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = onClick;

                const titleEl = document.createElement('div');
                titleEl.className = 'card-title';
                titleEl.textContent = title;

                const subtitleEl = document.createElement('div');
                subtitleEl.className = 'card-subtitle';
                subtitleEl.textContent = subtitle;

                card.appendChild(titleEl);
                card.appendChild(subtitleEl);

                return card;
            }

            async selectBook(book) {
                try {
                    this.showLoading(`טוען ספר ${book.heTitle || book.title}...`, 30);
                    this.log(`📖 נבחר ספר: ${book.title}`);
                    this.currentBook = book;
                    
                    this.commentaryCache.clear();
                    this.versionCache.clear();
                    this.log('🧹 ניקה cache');

                    this.bookData = await this.makeApiCall(
                        `${this.baseUrl}/v2/raw/index/${encodeURIComponent(book.title)}`,
                        `טעינת מידע ספר ${book.title}`
                    );

                    this.log('📊 מבנה הספר:', this.bookData);

                    // בדוק אם זהו מילון
                    if (this.isDictionary(this.bookData)) {
                        this.log('📖 זהו מילון');
                        this.showDictionaryStep();
                        this.hideLoading();
                        return;
                    }

                    if (this.bookData.schema && this.bookData.schema.nodes && this.bookData.schema.nodes.length > 0) {
                        this.log(`📚 ספר מורכב עם ${this.bookData.schema.nodes.length} חלקים`);
                        this.showSectionStep();
                    } else {
                        this.log('📖 ספר פשוט');
                        this.showChapterStep();
                        this.populateChapters();
                    }
                    
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    this.showError('שגיאה בטעינת הספר');
                }
            }

            isDictionary(bookData) {
                // בדוק אם יש DictionaryNode במבנה
                if (bookData.schema && bookData.schema.nodes) {
                    return bookData.schema.nodes.some(node => node.nodeType === 'DictionaryNode');
                }
                
                // בדוק אם יש lexiconName
                if (bookData.lexiconName) {
                    return true;
                }
                
                // בדוק קטגוריות
                if (bookData.categories && bookData.categories.includes('Dictionary')) {
                    return true;
                }
                
                return false;
            }

            showDictionaryStep() {
                this.log('📖 מציג ממשק מילון');
                
                // הסתר את כל הצעדים הרגילים
                document.getElementById('categoriesStep').classList.add('hidden');
                document.getElementById('sectionStep').classList.add('hidden');
                document.getElementById('chapterStep').classList.add('hidden');
                document.getElementById('paragraphStep').classList.add('hidden');
                
                // צור ממשק מיוחד למילון
                this.createDictionaryInterface();
            }

            createDictionaryInterface() {
                const container = document.querySelector('.container');
                
                // הסר ממשק מילון קיים אם יש
                const existingDict = document.getElementById('dictionaryStep');
                if (existingDict) {
                    existingDict.remove();
                }
                
                // צור ממשק חדש למילון
                const dictionaryStep = document.createElement('div');
                dictionaryStep.id = 'dictionaryStep';
                dictionaryStep.className = 'step';
                dictionaryStep.innerHTML = `
                    <div class="breadcrumb">📍 מילון > ${this.currentBook.heTitle || this.currentBook.title}</div>
                    
                    <div class="nav-buttons">
                        <button class="btn" id="backToBooksFromDict">🔙 חזור לספרים</button>
                        <button class="btn" id="homeFromDict">🏠 דף הבית</button>
                    </div>
                    
                    <div class="section">
                        <h3>🔍 חיפוש במילון: ${this.currentBook.heTitle || this.currentBook.title}</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            מילון זה מכיל ${this.getDictionaryInfo()} ויש להשתמש בחיפוש באתר ספריא ישירות.
                        </p>
                        
                        <div style="background: #f0f8ff; padding: 20px; border-radius: 10px; border-right: 4px solid #3498db;">
                            <h4>💡 איך להשתמש במילון:</h4>
                            <ol style="margin-top: 15px; padding-right: 20px;">
                                <li>היכנס לאתר ספריא: <a href="https://www.sefaria.org" target="_blank" style="color: #3498db;">sefaria.org</a></li>
                                <li>חפש "${this.currentBook.title}" בתיבת החיפוש</li>
                                <li>הקלד את המילה שאתה מחפש</li>
                                <li>המילון יציג את ההגדרה המלאה</li>
                            </ol>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; border-right: 4px solid #ffc107;">
                            <strong>📝 הערה:</strong> מילונים דורשים חיפוש ולא ניתן ליצור מהם מסמכים רגילים כמו ספרים אחרים.
                        </div>
                    </div>
                `;
                
                container.appendChild(dictionaryStep);
                
                // הוסף event listeners לכפתורי הניווט
                document.getElementById('backToBooksFromDict').addEventListener('click', () => {
                    this.backToBooks();
                });
                
                document.getElementById('homeFromDict').addEventListener('click', () => {
                    this.goHome();
                });
                
                this.log('📖 ממשק מילון נוצר');
            }

            getDictionaryInfo() {
                if (this.bookData.lexiconName) {
                    return `מילון ${this.bookData.lexiconName}`;
                }
                
                if (this.bookData.schema && this.bookData.schema.nodes) {
                    const dictNode = this.bookData.schema.nodes.find(node => node.nodeType === 'DictionaryNode');
                    if (dictNode && dictNode.headwordMap) {
                        return `כ-${dictNode.headwordMap.length} אותיות עם אלפי מילים`;
                    }
                }
                
                return 'מילון מקיף';
            }

            backToBooks() {
                // הסר את ממשק המילון
                const dictionaryStep = document.getElementById('dictionaryStep');
                if (dictionaryStep) {
                    dictionaryStep.remove();
                }
                
                // חזור לצעד הקטגוריות
                document.getElementById('categoriesStep').classList.remove('hidden');
                
                // איפוס משתנים
                this.currentBook = null;
                this.bookData = null;
                
                this.log('📚 חזרה לבחירת ספרים');
            }

            showSectionStep() {
                document.getElementById('categoriesStep').classList.add('hidden');
                document.getElementById('sectionStep').classList.remove('hidden');
                document.getElementById('selectedBookTitleSection').textContent = this.currentBook.heTitle || this.currentBook.title;
                this.populateSections();
            }

            populateSections() {
                const sectionSelect = document.getElementById('sectionSelect');
                sectionSelect.innerHTML = '<option value="">בחר חלק...</option>';

                if (this.bookData.schema && this.bookData.schema.nodes) {
                    this.bookData.schema.nodes.forEach((section, index) => {
                        const option = document.createElement('option');
                        option.value = section.key || section.title;
                        option.textContent = section.titles[1].text || section.title;
                        option.dataset.index = index;
                        sectionSelect.appendChild(option);
                    });
                    this.log(`📑 הוסף ${this.bookData.schema.nodes.length} חלקים`);
                }
            }

            async onSectionSelect() {
                const sectionSelect = document.getElementById('sectionSelect');
                const selectedOption = sectionSelect.options[sectionSelect.selectedIndex];

                if (!selectedOption.value) return;

                this.currentSection = {
                    key: selectedOption.value,
                    index: parseInt(selectedOption.dataset.index),
                    title: selectedOption.textContent,
                    data: this.bookData.schema.nodes[selectedOption.dataset.index],
                };

                this.log(`📑 נבחר חלק: ${this.currentSection.title}`, this.currentSection);
                this.showChapterStep();
                this.populateChaptersForSection();
            }

            populateChaptersForSection() {
                const chapterSelect = document.getElementById('chapterSelect');
                chapterSelect.innerHTML = '<option value="">בחר פרק...</option>';

                const sectionData = this.currentSection.data;
                this.log('📊 נתוני חלק:', sectionData);

                // בדוק אם יש nodes מקוננים (כמו בסידור)
                if (sectionData.nodes && Array.isArray(sectionData.nodes)) {
                    this.log('📚 נמצאו תת-חלקים מקוננים');
                    
                    // אם יש nodes, זה לא רמת הפרקים אלא רמת תת-חלקים
                    // נציג את התת-חלקים כאפשרויות
                    sectionData.nodes.forEach((subSection, index) => {
                        const option = document.createElement('option');
                        option.value = subSection.key || subSection.title || (index + 1);
                        
                        // נסה למצוא כותרת עברית
                        let displayName = subSection.key || subSection.title || `חלק ${index + 1}`;
                        if (subSection.titles && subSection.titles.length > 1) {
                            displayName = subSection.titles[1].text || displayName;
                        }
                        
                        option.textContent = displayName;
                        option.dataset.index = index;
                        option.dataset.isSubSection = 'true';
                        chapterSelect.appendChild(option);
                    });
                    
                    this.log(`📑 הוסף ${sectionData.nodes.length} תת-חלקים`);
                    
                    // עדכן את הכותרת לרמת תת-חלקים
                    const chapterStepTitle = document.querySelector('#chapterStep h3:nth-of-type(3)');
                    if (chapterStepTitle) {
                        chapterStepTitle.textContent = '🔢 בחר תת-חלק:';
                    }
                    
                } else if (sectionData.index_offsets_by_depth && sectionData.index_offsets_by_depth["2"]) {
                    // הלוגיקה המקורית לספרים עם offsets
                    const offsets = sectionData.index_offsets_by_depth["2"];
                    const numChapters = offsets.length;

                    this.log(`📖 לחלק יש ${numChapters} פרקים`);

                    for (let i = 1; i <= numChapters; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `פרק ${i}`;
                        chapterSelect.appendChild(option);
                    }
                    
                } else if (sectionData.content_counts && Array.isArray(sectionData.content_counts)) {
                    // נסה לשמוש ב-content_counts
                    const numChapters = sectionData.content_counts.length;
                    this.log(`📖 משתמש ב-content_counts: ${numChapters} פרקים`);
                    
                    for (let i = 1; i <= numChapters; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `פרק ${i}`;
                        chapterSelect.appendChild(option);
                    }
                    
                } else {
                    // fallback - ניסה לנחש לפי מבנה הספר
                    this.log('⚠️ לא נמצא מידע פרקים ברור, משתמש ב-fallback');
                    
                    // אם זהו תת-חלק סופי עם depth 1, זה כנראה פיסקאות ולא פרקים
                    if (sectionData.depth === 1) {
                        this.log('📄 זהו חלק עם פיסקאות ישירות');
                        const option = document.createElement('option');
                        option.value = 1;
                        option.textContent = 'פיסקאות';
                        chapterSelect.appendChild(option);
                    } else {
                        // ברירת מחדל - נניח שיש כמה פרקים
                        for (let i = 1; i <= 10; i++) {
                            const option = document.createElement('option');
                            option.value = i;
                            option.textContent = `פרק ${i}`;
                            chapterSelect.appendChild(option);
                        }
                        this.log('📚 הוסף 10 פרקים כברירת מחדל');
                    }
                }

                document.getElementById('selectedSectionTitle').classList.remove('hidden');
                document.getElementById('selectedSectionName').textContent = this.currentSection.title;
            }

            showChapterStep() {
                document.getElementById('categoriesStep').classList.add('hidden');
                document.getElementById('sectionStep').classList.add('hidden');
                document.getElementById('chapterStep').classList.remove('hidden');
                document.getElementById('selectedBookTitle').textContent = this.currentBook.heTitle || this.currentBook.title;

                if (this.currentSection) {
                    document.getElementById('selectedSectionTitle').classList.remove('hidden');
                    document.getElementById('selectedSectionName').textContent = this.currentSection.title;
                    document.getElementById('backToSectionBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('selectedSectionTitle').classList.add('hidden');
                    document.getElementById('backToSectionBtn').style.display = 'none';
                }
            }

            populateChapters() {
                const chapterSelect = document.getElementById('chapterSelect');
                chapterSelect.innerHTML = '<option value="">בחר פרק...</option>';

                let chapterCount = 0;
                
                this.log('📊 מבנה ספר:', this.bookData);
                
                // בדוק אם זהו ספר חד-פרקי (כמו מאמרים או טקסטים קצרים)
                if (this.isSingleChapterBook()) {
                    this.log('📄 ספר חד-פרקי');
                    const option = document.createElement('option');
                    option.value = 1;
                    option.textContent = 'טקסט מלא';
                    chapterSelect.appendChild(option);
                    return;
                }
                
                if (this.bookData.schema && this.bookData.schema.lengths && this.bookData.schema.lengths.length > 0) {
                    chapterCount = this.bookData.schema.lengths[0];
                    this.log(`📚 משתמש ב-schema.lengths: ${chapterCount} פרקים`);
                } else if (this.bookData.schema && this.bookData.schema.content_counts && this.bookData.schema.content_counts.length > 0) {
                    chapterCount = this.bookData.schema.content_counts.length;
                    this.log(`📚 משתמש ב-schema.content_counts: ${chapterCount} פרקים`);
                } else if (this.bookData.lengths && this.bookData.lengths.length > 0) {
                    chapterCount = this.bookData.lengths[0];
                    this.log(`📚 משתמש ב-book.lengths: ${chapterCount} פרקים`);
                } else if (this.bookData.schema && this.bookData.schema.depth === 1) {
                    // ספר עם עומק 1 - כנראה פיסקאות ישירות
                    this.log('📄 ספר עם פיסקאות ישירות');
                    const option = document.createElement('option');
                    option.value = 1;
                    option.textContent = 'פיסקאות';
                    chapterSelect.appendChild(option);
                    return;
                } else {
                    // ברירת מחדל מותאמת לפי סוג הספר
                    chapterCount = this.estimateChapterCount();
                    this.log(`📚 משתמש בהערכה: ${chapterCount} פרקים`);
                }
                
                for (let i = 1; i <= chapterCount; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `פרק ${i}`;
                    chapterSelect.appendChild(option);
                }
                
                this.log(`📚 הוסף ${chapterCount} פרקים למנו`);
            }

            isSingleChapterBook() {
                // בדוק אם זהו ספר חד-פרקי
                if (this.bookData.schema && this.bookData.schema.depth === 1) {
                    return true;
                }
                
                // בדוק אם יש רק פרק אחד
                if (this.bookData.schema && this.bookData.schema.lengths && this.bookData.schema.lengths[0] === 1) {
                    return true;
                }
                
                // בדוק לפי קטגוריות
                if (this.bookData.categories) {
                    const singleChapterCategories = ['Modern Works', 'Essays', 'Articles'];
                    if (this.bookData.categories.some(cat => singleChapterCategories.includes(cat))) {
                        return true;
                    }
                }
                
                return false;
            }

            estimateChapterCount() {
                // הערכת מספר פרקים לפי סוג הספר
                
                if (this.bookData.categories) {
                    // לפי קטגוריות
                    if (this.bookData.categories.includes('Tanakh')) {
                        return 150; // תהילים הוא הארוך ביותר
                    }
                    if (this.bookData.categories.includes('Talmud')) {
                        return 100; // מסכתות גדולות
                    }
                    if (this.bookData.categories.includes('Midrash')) {
                        return 50;
                    }
                    if (this.bookData.categories.includes('Halakha')) {
                        return 30;
                    }
                    if (this.bookData.categories.includes('Kabbalah')) {
                        return 20;
                    }
                    if (this.bookData.categories.includes('Philosophy')) {
                        return 15;
                    }
                }
                
                // ברירת מחדל כללית
                return 50;
            }

            async onChapterSelect() {
                const chapterSelect = document.getElementById('chapterSelect');
                const selectedOption = chapterSelect.options[chapterSelect.selectedIndex];
                const chapterNum = selectedOption.value;
                
                if (!chapterNum) return;

                try {
                    this.showLoading(`בודק מבנה...`, 40);
                    this.log(`📄 בחירת פרק/תת-חלק: ${chapterNum}`);
                    
                    // בדוק אם זהו תת-חלק (כמו בסידור) או פרק רגיל
                    const isSubSection = selectedOption.dataset.isSubSection === 'true';
                    
                    if (isSubSection) {
                        // זהו תת-חלק מקונן - בדוק אם יש עוד רמות
                        const sectionIndex = parseInt(selectedOption.dataset.index);
                        const subSectionData = this.currentSection.data.nodes[sectionIndex];
                        
                        this.log('📊 נתוני תת-חלק:', subSectionData);
                        
                        if (subSectionData.nodes && Array.isArray(subSectionData.nodes)) {
                            // יש עוד רמה - צריך לעבור לרמה הבאה
                            this.log(`📚 נמצאו ${subSectionData.nodes.length} תתי-חלקים נוספים`);
                            this.currentSubSection = {
                                key: chapterNum,
                                data: subSectionData,
                                index: sectionIndex
                            };
                            this.showSubSectionStep(subSectionData);
                            this.hideLoading();
                            return;
                        } else {
                            // זוהי הרמה הסופית
                            this.currentChapter = chapterNum;
                            let chapterRef = `${this.currentBook.title}, ${this.currentSection.key}, ${chapterNum}`;
                            this.log(`🔗 הפניית תת-חלק סופי: ${chapterRef}`);
                            await this.loadChapterDataOptimized(chapterRef);
                        }
                    } else {
                        // פרק רגיל
                        this.currentChapter = chapterNum;
                        let chapterRef;
                        if (this.currentSection) {
                            chapterRef = `${this.currentBook.title}, ${this.currentSection.key} ${chapterNum}`;
                        } else {
                            chapterRef = `${this.currentBook.title} ${chapterNum}`;
                        }
                        this.log(`🔗 הפניית פרק רגיל: ${chapterRef}`);
                        await this.loadChapterDataOptimized(chapterRef);
                    }

                    this.showParagraphStep();
                    this.populateParagraphs();
                    this.updateStats();
                    
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    this.log(`❌ שגיאה בטעינת הפרק: ${error.message}`, null, 'error');
                    this.showError('שגיאה בטעינת הפרק');
                }
            }

            showSubSectionStep(subSectionData) {
                // בדוק אם יש עוד רמה מקוננת
                this.log('🔄 בודק אם יש רמות נוספות במבנה');
                this.log('📊 נתוני תת-חלק:', subSectionData);
                
                // עדכן את הכותרת
                const chapterStepTitle = document.querySelector('#chapterStep h3:nth-of-type(3)');
                
                // מלא את הסלקט
                const chapterSelect = document.getElementById('chapterSelect');
                chapterSelect.innerHTML = '<option value="">בחר...</option>';
                
                subSectionData.nodes.forEach((item, index) => {
                    const option = document.createElement('option');
                    option.value = item.key || item.title || (index + 1);
                    
                    // חפש כותרת עברית
                    let displayName = item.key || item.title || `פריט ${index + 1}`;
                    if (item.titles && item.titles.length > 1) {
                        displayName = item.titles[1].text || displayName;
                    } else if (item.titles && item.titles.length > 0) {
                        const title = item.titles[0];
                        if (title.lang === 'he') {
                            displayName = title.text;
                        }
                    }
                    
                    option.textContent = displayName;
                    option.dataset.index = index;
                    
                    // בדוק אם יש עוד nodes (רמה נוספת) או שזהו הסוף
                    if (item.nodes && Array.isArray(item.nodes)) {
                        // יש עוד רמה - זהו תת-קטגוריה
                        option.dataset.hasSubNodes = 'true';
                        this.log(`📁 ${displayName} מכיל ${item.nodes.length} תתי-פריטים`);
                        
                        if (chapterStepTitle) {
                            chapterStepTitle.textContent = '🔢 בחר קטגוריה:';
                        }
                    } else {
                        // זוהי התפילה הסופית
                        option.dataset.isFinalPrayer = 'true';
                        this.log(`🙏 ${displayName} הוא תפילה סופית`);
                        
                        if (chapterStepTitle) {
                            chapterStepTitle.textContent = '🔢 בחר תפילה:';
                        }
                    }
                    
                    chapterSelect.appendChild(option);
                });
                
                this.log(`📝 הוסף ${subSectionData.nodes.length} פריטים`);
            }

            async handleSubCategorySelection() {
                const chapterSelect = document.getElementById('chapterSelect');
                const selectedOption = chapterSelect.options[chapterSelect.selectedIndex];
                const categoryKey = selectedOption.value;
                
                if (!categoryKey) return;
                
                try {
                    this.log(`📂 נבחרה קטגוריה: ${categoryKey}`);
                    
                    // קבל את נתוני הקטגוריה
                    const categoryIndex = parseInt(selectedOption.dataset.index);
                    const categoryData = this.currentSubSection.data.nodes[categoryIndex];
                    
                    this.log('📊 נתוני קטגוריה:', categoryData);
                    
                    // עדכן את currentSubSection עם הקטגוריה החדשה
                    this.currentSubSection = {
                        ...this.currentSubSection,
                        categoryKey: categoryKey,
                        categoryData: categoryData,
                        categoryIndex: categoryIndex
                    };
                    
                    // הצג את התפילות בקטגוריה זו
                    this.showFinalPrayersStep(categoryData);
                    
                } catch (error) {
                    this.log(`❌ שגיאה בטיפול בקטגוריה: ${error.message}`, null, 'error');
                    this.showError('שגיאה בטעינת הקטגוריה');
                }
            }

            showFinalPrayersStep(categoryData) {
                this.log('🙏 מציג תפילות סופיות');
                
                // עדכן את הכותרת
                const chapterStepTitle = document.querySelector('#chapterStep h3:nth-of-type(3)');
                if (chapterStepTitle) {
                    chapterStepTitle.textContent = '🔢 בחר תפילה:';
                }
                
                // מלא את הסלקט עם התפילות הספציפיות
                const chapterSelect = document.getElementById('chapterSelect');
                chapterSelect.innerHTML = '<option value="">בחר תפילה...</option>';
                
                categoryData.nodes.forEach((prayer, index) => {
                    const option = document.createElement('option');
                    option.value = prayer.key || prayer.title || (index + 1);
                    
                    // חפש כותרת עברית
                    let displayName = prayer.key || prayer.title || `תפילה ${index + 1}`;
                    if (prayer.titles && prayer.titles.length > 1) {
                        displayName = prayer.titles[1].text || displayName;
                    } else if (prayer.titles && prayer.titles.length > 0) {
                        const title = prayer.titles[0];
                        if (title.lang === 'he') {
                            displayName = title.text;
                        }
                    }
                    
                    option.textContent = displayName;
                    option.dataset.index = index;
                    option.dataset.isFinalPrayer = 'true';
                    chapterSelect.appendChild(option);
                });
                
                this.log(`🙏 הוסף ${categoryData.nodes.length} תפילות סופיות`);
            }

            async handleFinalPrayerSelection() {
                const chapterSelect = document.getElementById('chapterSelect');
                const selectedOption = chapterSelect.options[chapterSelect.selectedIndex];
                const prayerKey = selectedOption.value;
                
                if (!prayerKey) return;
                
                try {
                    this.showLoading(`טוען תפילה...`, 60);
                    this.currentChapter = prayerKey;
                    
                    // בנה הפניה לתפילה ספציפית - 5 רמות!
                    let chapterRef;
                    if (this.currentSubSection && this.currentSubSection.categoryKey) {
                        // 5 רמות: ספר, חלק, תת-חלק, קטגוריה, תפילה
                        chapterRef = `${this.currentBook.title}, ${this.currentSection.key}, ${this.currentSubSection.key}, ${this.currentSubSection.categoryKey}, ${prayerKey}`;
                    } else if (this.currentSubSection) {
                        // 4 רמות: ספר, חלק, תת-חלק, תפילה
                        chapterRef = `${this.currentBook.title}, ${this.currentSection.key}, ${this.currentSubSection.key}, ${prayerKey}`;
                    } else if (this.currentSection) {
                        // 3 רמות: ספר, חלק, תפילה
                        chapterRef = `${this.currentBook.title}, ${this.currentSection.key}, ${prayerKey}`;
                    } else {
                        // 2 רמות: ספר, תפילה
                        chapterRef = `${this.currentBook.title}, ${prayerKey}`;
                    }
                    
                    this.log(`🔗 הפניית תפילה (5 רמות): ${chapterRef}`);
                    await this.loadChapterDataOptimized(chapterRef);
                    
                    this.showParagraphStep();
                    this.populateParagraphs();
                    this.updateStats();
                    
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    this.log(`❌ שגיאה בטעינת התפילה: ${error.message}`, null, 'error');
                    this.showError('שגיאה בטעינת התפילה');
                }
            }

            async loadChapterDataOptimized(chapterRef) {
                const cacheKey = this.getCacheKey('chapter', chapterRef);
                
                if (this.versionCache.has(cacheKey)) {
                    this.apiStats.cacheHits++;
                    this.chapterData = this.versionCache.get(cacheKey);
                    this.log('📋 משתמש בנתוני פרק מהזיכרון');
                    return;
                }

                try {
                    this.log(`🌐 שולף נתוני פרק: ${chapterRef}`);
                    this.chapterData = await this.makeApiCall(
                        `${this.baseUrl}/texts/${encodeURIComponent(chapterRef)}`,
                        `טעינת פרק ${chapterRef}`
                    );

                    this.log('📊 מבנה נתוני הפרק:', this.chapterData);

                    // בדוק פורמטים שונים של תגובת API
                    if (this.chapterData.he && Array.isArray(this.chapterData.he)) {
                        // פורמט רגיל - מערך של פסוקים/פיסקאות
                        this.versionCache.set(cacheKey, this.chapterData);
                        this.log(`✅ טען ${this.chapterData.he.length} פסוקים בפורמט רגיל`);
                        
                    } else if (this.chapterData.he && typeof this.chapterData.he === 'string') {
                        // פורמט של טקסט יחיד - נכניס אותו למערך
                        this.chapterData.he = [this.chapterData.he];
                        this.versionCache.set(cacheKey, this.chapterData);
                        this.log(`✅ טען טקסט יחיד, הומר למערך`);
                        
                    } else if (this.chapterData.text && Array.isArray(this.chapterData.text)) {
                        // לפעמים הטקסט מגיע בשדה 'text' במקום 'he'
                        this.chapterData.he = this.chapterData.text;
                        this.versionCache.set(cacheKey, this.chapterData);
                        this.log(`✅ טען ${this.chapterData.he.length} פסוקים מהשדה text`);
                        
                    } else if (this.chapterData.text && typeof this.chapterData.text === 'string') {
                        // טקסט יחיד בשדה text
                        this.chapterData.he = [this.chapterData.text];
                        this.versionCache.set(cacheKey, this.chapterData);
                        this.log(`✅ טען טקסט יחיד מהשדה text`);
                        
                    } else {
                        // נסה לטעון פיסקא אחר פיסקא
                        this.log('⚠️ פורמט לא צפוי, מנסה טעינה פיסקא אחר פיסקא');
                        await this.loadParagraphByParagraphFallback(chapterRef);
                    }
                    
                } catch (error) {
                    this.log(`❌ שגיאה בטעינת פרק: ${error.message}`, null, 'error');
                    
                    // נסה fallback
                    this.log('🔄 מנסה טעינה חלופית...');
                    await this.loadParagraphByParagraphFallback(chapterRef);
                }
            }

            async loadParagraphByParagraphFallback(chapterRef) {
                this.log(`🔍 טעינה חלופית פיסקא אחר פיסקא: ${chapterRef}`);
                
                this.chapterData = { he: [] };
                const maxAttempts = 50;
                const maxFailures = 5;
                let consecutiveFailures = 0;

                for (let paragraphNum = 1; paragraphNum <= maxAttempts; paragraphNum++) {
                    const paragraphRef = `${chapterRef}:${paragraphNum}`;

                    try {
                        const response = await fetch(`${this.baseUrl}/texts/${encodeURIComponent(paragraphRef)}`);

                        if (response.ok) {
                            const paragraphData = await response.json();

                            if (paragraphData.he || paragraphData.text) {
                                const paragraphText = paragraphData.he || paragraphData.text;
                                const cleanText = Array.isArray(paragraphText) ? 
                                    paragraphText[0] || paragraphText.join(' ') : paragraphText;

                                if (cleanText && cleanText.trim()) {
                                    this.chapterData.he.push(cleanText);
                                    this.log(`✅ נמצא פסוק ${paragraphNum}`);
                                    consecutiveFailures = 0;
                                } else {
                                    consecutiveFailures++;
                                }
                            } else {
                                consecutiveFailures++;
                            }
                        } else if (response.status === 404) {
                            consecutiveFailures++;
                            this.log(`⏭️ פסוק ${paragraphNum} לא נמצא (404)`);
                        } else {
                            consecutiveFailures++;
                        }

                        // עצור אם יש יותר מדי כישלונות רצופים
                        if (consecutiveFailures >= maxFailures) {
                            this.log(`🛑 עוצר אחרי ${maxFailures} כישלונות רצופים`);
                            break;
                        }

                        // השהיה קצרה בין בקשות
                        await new Promise(resolve => setTimeout(resolve, 100));

                    } catch (error) {
                        this.log(`❌ שגיאה בשליפת פסוק ${paragraphNum}: ${error.message}`);
                        consecutiveFailures++;

                        if (consecutiveFailures >= maxFailures) {
                            break;
                        }
                    }
                }

                this.log(`📊 טעינה חלופית הושלמה: ${this.chapterData.he.length} פסוקים נמצאו`);

                if (this.chapterData.he.length === 0) {
                    throw new Error('לא נמצאו פסוקים לפרק זה');
                }
            }

            showParagraphStep() {
                document.getElementById('chapterStep').classList.add('hidden');
                document.getElementById('paragraphStep').classList.remove('hidden');

                let title = `${this.currentBook.heTitle || this.currentBook.title}`;
                if (this.currentSection) {
                    title += `, ${this.currentSection.title}`;
                }
                title += ` פרק ${this.currentChapter}`;

                document.getElementById('selectedChapterTitle').textContent = title;
            }

            populateParagraphs() {
                const startSelect = document.getElementById('startParagraph');
                const endSelect = document.getElementById('endParagraph');
                
                startSelect.innerHTML = '<option value="">בחר התחלה...</option>';
                endSelect.innerHTML = '<option value="">בחר סוף...</option>';

                if (this.chapterData.he && Array.isArray(this.chapterData.he)) {
                    const numParagraphs = this.chapterData.he.length;
                    this.log(`📝 פרק כולל ${numParagraphs} פסוקים`);

                    for (let i = 1; i <= numParagraphs; i++) {
                        const startOption = document.createElement('option');
                        startOption.value = i;
                        startOption.textContent = `פסוק ${i}`;
                        startSelect.appendChild(startOption);

                        const endOption = document.createElement('option');
                        endOption.value = i;
                        endOption.textContent = `פסוק ${i}`;
                        endSelect.appendChild(endOption);
                    }
                } else {
                    this.log('❌ לא נמצאו נתוני פסוקים', 'error');
                }
            }

            updateStats() {
                const totalVerses = this.chapterData.he ? this.chapterData.he.length : 0;
                document.getElementById('totalVerses').textContent = totalVerses;
                
                const selectedRange = this.getSelectedRange();
                document.getElementById('selectedRange').textContent = selectedRange;
                
                // נעדכן את מספר המפרשים כאשר נטען אותם
                document.getElementById('commentariesCount').textContent = '-';
            }

            getSelectedRange() {
                const start = document.getElementById('startParagraph').value;
                const end = document.getElementById('endParagraph').value;
                
                if (start && end) {
                    return Math.abs(parseInt(end) - parseInt(start)) + 1;
                }
                return '-';
            }

            async onParagraphRangeChange() {
                const start = document.getElementById('startParagraph').value;
                const end = document.getElementById('endParagraph').value;

                this.updateStats();

                if (start && end) {
                    this.log(`📝 נבחר טווח: ${start} עד ${end}`);

                    try {
                        this.showLoading('טוען גירסאות ומפרשים...', 60);
                        
                        await Promise.all([
                            this.loadVersionsOptimized(),
                            this.loadCommentariesOptimized()
                        ]);

                        document.getElementById('generateBtn').disabled = false;
                        this.hideLoading();
                    } catch (error) {
                        this.hideLoading();
                        this.log('❌ שגיאה בטעינת גירסאות או מפרשים', null, 'error');
                    }
                } else {
                    document.getElementById('generateBtn').disabled = true;
                }
            }

            async loadVersionsOptimized() {
                try {
                    const cacheKey = this.getCacheKey('versions', this.currentBook.title);
                    
                    let versions;
                    if (this.versionCache.has(cacheKey)) {
                        this.apiStats.cacheHits++;
                        versions = this.versionCache.get(cacheKey);
                        this.log('📋 משתמש בגירסאות מהזיכרון');
                    } else {
                        versions = await this.makeApiCall(
                            `${this.baseUrl}/texts/versions/${encodeURIComponent(this.currentBook.title)}`,
                            'טעינת גירסאות'
                        );
                        this.versionCache.set(cacheKey, versions);
                    }

                    const container = document.getElementById('versionsContainer');
                    container.innerHTML = '';

                    if (Array.isArray(versions)) {
                        let addedVersions = 0;
                        versions.forEach(version => {
                            if (version.languageFamilyName !== 'hebrew' || !version.isPrimary) {
                                const label = document.createElement('label');
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.value = version.versionTitle;
                                checkbox.dataset.language = version.languageFamilyName;
                                checkbox.dataset.title = version.versionTitle;

                                label.appendChild(checkbox);
                                label.appendChild(document.createTextNode(`${version.versionTitle} (${version.languageFamilyName})`));
                                container.appendChild(label);
                                addedVersions++;
                            }
                        });
                        this.log(`📚 הוסף ${addedVersions} גירסאות`);
                    }
                } catch (error) {
                    this.log(`❌ שגיאה בטעינת גירסאות: ${error.message}`, null, 'error');
                    document.getElementById('versionsContainer').innerHTML = '<div>שגיאה בטעינת גירסאות</div>';
                }
            }

            async loadCommentariesOptimized() {
                try {
                    const start = document.getElementById('startParagraph').value;
                    if (!start) return;

                    let sampleRef;
                    if (this.currentSubSection && this.currentSubSection.categoryKey) {
                        sampleRef = `${this.currentBook.title}, ${this.currentSection.key}, ${this.currentSubSection.key}, ${this.currentSubSection.categoryKey}, ${this.currentChapter}:${start}`;
                    } else if (this.currentSubSection) {
                        sampleRef = `${this.currentBook.title}, ${this.currentSection.key}, ${this.currentSubSection.key}, ${this.currentChapter}:${start}`;
                    } else if (this.currentSection) {
                        sampleRef = `${this.currentBook.title}, ${this.currentSection.key} ${this.currentChapter}:${start}`;
                    } else {
                        sampleRef = `${this.currentBook.title} ${this.currentChapter}:${start}`;
                    }

                    const cacheKey = this.getCacheKey('commentaries', sampleRef);
                    
                    let commentaries;
                    if (this.commentaryCache.has(cacheKey)) {
                        this.apiStats.cacheHits++;
                        commentaries = this.commentaryCache.get(cacheKey);
                        this.log('📋 משתמש במפרשים מהזיכרון');
                    } else {
                        commentaries = await this.discoverCommentariesOptimized(sampleRef);
                        this.commentaryCache.set(cacheKey, commentaries);
                    }

                    const container = document.getElementById('commentariesContainer');
                    container.innerHTML = '';

                    if (commentaries.size > 0) {
                        commentaries.forEach(title => {
                            const label = document.createElement('label');
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.value = title;

                            label.appendChild(checkbox);
                            label.appendChild(document.createTextNode(title));
                            container.appendChild(label);
                        });

                        document.getElementById('commentariesCount').textContent = commentaries.size;
                        this.log(`✅ נמצאו ${commentaries.size} מפרשים`);
                    } else {
                        container.innerHTML = '<div>לא נמצאו מפרשים זמינים</div>';
                        document.getElementById('commentariesCount').textContent = '0';
                    }
                } catch (error) {
                    this.log(`❌ שגיאה בטעינת מפרשים: ${error.message}`, null, 'error');
                    document.getElementById('commentariesContainer').innerHTML = '<div>שגיאה בטעינת מפרשים</div>';
                }
            }

            async discoverCommentariesOptimized(ref) {
                const commentaries = new Set();

                try {
                    const links = await this.makeApiCall(
                        `${this.baseUrl}/links/${encodeURIComponent(ref)}`,
                        'טעינת קישורים למפרשים'
                    );

                    if (Array.isArray(links)) {
                        links.forEach(link => {
                            if (link.category === 'Commentary' && link.collectiveTitle) {
                                const title = link.collectiveTitle.he || link.collectiveTitle.en;
                                if (title) {
                                    commentaries.add(title);
                                    this.log(`📝 נמצא מפרש: ${title}`);
                                }
                            }
                        });
                    }
                } catch (error) {
                    this.log(`❌ שגיאה בחיפוש מפרשים: ${error.message}`);
                }

                return commentaries;
            }

            async generateDocument() {
                try {
                    this.log('📄 מתחיל יצירת מסמך...');
                    this.showLoading('מכין מסמך מקצועי...', 70);
                    
                    document.getElementById('generateBtn').disabled = true;

                    const start = parseInt(document.getElementById('startParagraph').value);
                    const end = parseInt(document.getElementById('endParagraph').value);

                    const selectedVersions = Array.from(document.querySelectorAll('#versionsContainer input[type="checkbox"]:checked'))
                        .map(cb => ({
                            title: cb.dataset.title,
                            language: cb.dataset.language
                        }))
                        .filter(v => v.title && v.language);

                    const selectedCommentaries = Array.from(document.querySelectorAll('#commentariesContainer input:checked'))
                        .map(cb => cb.value);

                    this.log(`📊 טווח נבחר: ${start} עד ${end}`);
                    this.log(`📚 גירסאות נבחרות:`, selectedVersions);
                    this.log(`📝 מפרשים נבחרים: ${selectedCommentaries.join(', ') || 'ללא'}`);

                    this.showLoading('אוסף תוכן...', 80);
                    const documentData = await this.fetchDocumentDataOptimized(start, end, selectedVersions, selectedCommentaries);

                    this.showLoading('מייצר מסמך Word...', 95);
                    this.createProfessionalWordDocument(documentData);

                    this.log('✅ מסמך נוצר בהצלחה!', null, 'success');
                    this.showSuccess('המסמך נוצר בהצלחה!');
                    this.hideLoading();

                } catch (error) {
                    this.log(`❌ שגיאה ביצירת מסמך: ${error.message}`, null, 'error');
                    this.showError('שגיאה ביצירת המסמך');
                    this.hideLoading();
                } finally {
                    document.getElementById('generateBtn').disabled = false;
                }
            }

            async fetchDocumentDataOptimized(startParagraph, endParagraph, selectedVersions, selectedCommentaries) {
                const documentData = [];
                const totalParagraphs = endParagraph - startParagraph + 1;
                let processedParagraphs = 0;

                this.log(`📚 מעבד פסוקים ${startParagraph} עד ${endParagraph}`);

                for (let verseNum = startParagraph; verseNum <= endParagraph; verseNum++) {
                    this.log(`📄 מעבד פסוק ${verseNum}`);

                    const arrayIndex = verseNum - 1;
                    
                    if (arrayIndex < 0 || arrayIndex >= this.chapterData.he.length) {
                        this.log(`⚠️ אינדקס לא תקין ${arrayIndex} לפסוק ${verseNum}`);
                        continue;
                    }

                    const hebrewText = this.chapterData.he[arrayIndex];
                    
                    let paragraphRef;
                    if (this.currentSubSection && this.currentSubSection.categoryKey) {
                        // 5 רמות: ספר, חלק, תת-חלק, קטגוריה, תפילה:פסוק
                        paragraphRef = `${this.currentBook.title}, ${this.currentSection.key}, ${this.currentSubSection.key}, ${this.currentSubSection.categoryKey}, ${this.currentChapter}:${verseNum}`;
                    } else if (this.currentSubSection) {
                        // 4 רמות: ספר, חלק, תת-חלק, תפילה:פסוק
                        paragraphRef = `${this.currentBook.title}, ${this.currentSection.key}, ${this.currentSubSection.key}, ${this.currentChapter}:${verseNum}`;
                    } else if (this.currentSection) {
                        // 3 רמות: ספר, חלק, פרק:פסוק
                        paragraphRef = `${this.currentBook.title}, ${this.currentSection.key} ${this.currentChapter}:${verseNum}`;
                    } else {
                        // 2 רמות: ספר פרק:פסוק
                        paragraphRef = `${this.currentBook.title} ${this.currentChapter}:${verseNum}`;
                    }
                    
                    this.log(`🔗 הפניית פסוק: ${paragraphRef}`);
                    
                    try {
                        const cleanText = hebrewText.replace(/<[^>]*>/g, '').trim();

                        if (!cleanText) {
                            this.log(`⚠️ טקסט ריק לפסוק ${verseNum}`);
                            continue;
                        }

                        // עדכון אחוזי התקדמות
                        processedParagraphs++;
                        const progress = 80 + (processedParagraphs / totalParagraphs) * 15;
                        this.showLoading(`מעבד פסוק ${verseNum}/${endParagraph}...`, progress);

                        const [commentaries, additionalVersions] = await Promise.all([
                            this.fetchCommentariesForParagraphOptimized(paragraphRef, selectedCommentaries),
                            this.fetchAdditionalVersionsOptimized(paragraphRef, selectedVersions, arrayIndex)
                        ]);

                        documentData.push({
                            paragraphNum: verseNum,
                            ref: paragraphRef,
                            hebrewText: cleanText,
                            additionalVersions,
                            commentaries
                        });

                        this.log(`✅ הוסף פסוק ${verseNum} עם ${commentaries.length} מפרשים`);

                    } catch (error) {
                        this.log(`❌ שגיאה בעיבוד פסוק ${verseNum}: ${error.message}`, null, 'error');
                    }

                    // השהיה קצרה בין בקשות
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                this.log(`🎉 נתוני מסמך מוכנים: ${documentData.length} פסוקים`);
                return documentData;
            }

            async fetchCommentariesForParagraphOptimized(ref, selectedCommentaries) {
                if (selectedCommentaries.length === 0) return [];

                try {
                    this.log(`📝 שולף מפרשים עבור: ${ref}`);

                    const response = await fetch(`${this.baseUrl}/links/${encodeURIComponent(ref)}`);
                    const links = await response.json();

                    const commentaries = [];

                    if (Array.isArray(links)) {
                        for (const link of links) {
                            if (link.category === 'Commentary' && link.collectiveTitle) {
                                const commentaryTitle = link.collectiveTitle.he || link.collectiveTitle.en;

                                if (selectedCommentaries.includes(commentaryTitle)) {
                                    this.log(`🔍 מעבד מפרש: ${commentaryTitle} -> ${link.sourceRef}`);

                                    // שלוף את טקסט הפירוש באופן חכם יותר
                                    const commentaryText = await this.fetchCommentaryTextSmart(link.sourceRef, ref);
                                    if (commentaryText) {
                                        commentaries.push({
                                            title: commentaryTitle,
                                            text: commentaryText,
                                            ref: link.sourceRef
                                        });
                                        this.log(`✅ הוסף מפרש: ${commentaryTitle} (${commentaryText.length} תווים)`);
                                    }
                                }
                            }
                        }
                    }

                    return commentaries;
                } catch (error) {
                    this.log(`❌ שגיאה בשליפת מפרשים עבור ${ref}: ${error.message}`, null, 'error');
                    return [];
                }
            }

            async fetchCommentaryTextSmart(commentaryRef, originalRef) {
                try {
                    this.log(`📖 שולף מפרש בצורה חכמה: ${commentaryRef}`);

                    // פרק את ההפניה לזיהוי הפיסקא הספציפית
                    const { baseRef, paragraphNum } = this.parseCommentaryRef(commentaryRef, originalRef);

                    this.log(`🔍 פורק: baseRef=${baseRef}, paragraphNum=${paragraphNum}`);

                    // שלוף את כל הפירוש (הדף/פרק) בבת אחת
                    const response = await fetch(`${this.baseUrl}/texts/${encodeURIComponent(baseRef)}`);
                    const data = await response.json();

                    this.log(`📊 נתוני מפרש עבור ${baseRef}:`, data);

                    // חלץ את הטקסט הספציפי מהמערך
                    let text = '';

                    if (data.he && Array.isArray(data.he) && paragraphNum !== null) {
                        // יש מערך ואנחנו יודעים איזה פיסקא
                        const paragraphIndex = paragraphNum - 1;
                        if (paragraphIndex >= 0 && paragraphIndex < data.he.length) {
                            text = data.he[paragraphIndex];
                            this.log(`✅ נמצא פסקה ספציפית ${paragraphNum}: ${text.substring(0, 100)}...`);
                        } else {
                            this.log(`❌ פסקה ${paragraphNum} לא נמצאה במערך של ${data.he.length} פריטים`);
                        }
                    } else if (data.he) {
                        // אם אין מערך או לא יודעים את המספר, קח את הכל
                        if (Array.isArray(data.he)) {
                            text = data.he.join(' ');
                        } else {
                            text = data.he;
                        }
                        this.log(`📄 משתמש בטקסט מפרש מלא (${text.length} תווים)`);
                    } else if (data.text) {
                        if (Array.isArray(data.text)) {
                            text = data.text.join(' ');
                        } else {
                            text = data.text;
                        }
                    }

                    // נקה את הטקסט מ-HTML tags
                    if (text) {
                        text = text.replace(/<[^>]*>/g, '').trim();
                    }

                    this.log(`📝 טקסט מפרש סופי (${text.length} תווים): ${text.substring(0, 100)}...`);
                    return text;

                } catch (error) {
                    this.log(`❌ שגיאה בשליפת טקסט מפרש: ${error.message}`, null, 'error');
                    return '';
                }
            }

            parseCommentaryRef(commentaryRef, originalRef) {
                // נסה לפרק את ההפניה למציאת הפיסקא הרלוונטית
                try {
                    // דוגמא: "Mikdash Melekh on Zohar 1:1a:1" -> baseRef="Mikdash Melekh on Zohar 1:1a", paragraphNum=1
                    const parts = commentaryRef.split(':');

                    if (parts.length >= 3) {
                        // יש מספר פיסקא באחרון
                        const paragraphNum = parseInt(parts[parts.length - 1]);
                        const baseRef = parts.slice(0, -1).join(':');

                        if (!isNaN(paragraphNum)) {
                            return { baseRef, paragraphNum };
                        }
                    }

                    // אם לא הצלחנו לפרק, נחזיר את כל ההפניה כ-baseRef
                    return { baseRef: commentaryRef, paragraphNum: null };

                } catch (error) {
                    this.log(`❌ שגיאה בפירוק הפניית מפרש: ${error.message}`);
                    return { baseRef: commentaryRef, paragraphNum: null };
                }
            }

            async fetchAdditionalVersionsOptimized(ref, selectedVersions, arrayIndex) {
                if (!selectedVersions || selectedVersions.length === 0) {
                    return [];
                }

                const versions = [];

                for (const version of selectedVersions) {
                    try {
                        if (!version.title || !version.language) {
                            continue;
                        }
                        
                        const cacheKey = this.getCacheKey('version_chapter', this.currentChapter, version.title);
                        
                        let versionChapterData;
                        if (this.versionCache.has(cacheKey)) {
                            this.apiStats.cacheHits++;
                            versionChapterData = this.versionCache.get(cacheKey);
                        } else {
                            const chapterRef = ref.split(':')[0];
                            const versionParam = encodeURIComponent(`${version.language}|${version.title}`);
                            
                            versionChapterData = await this.makeApiCall(
                                `${this.baseUrl}/v3/texts/${encodeURIComponent(chapterRef)}?version=${versionParam}`,
                                `טעינת גירסה ${version.title} לפרק`
                            );
                            
                            this.versionCache.set(cacheKey, versionChapterData);
                        }
                        
                        let versionText = '';
                        if (versionChapterData.versions && versionChapterData.versions[0] && versionChapterData.versions[0].text) {
                            versionText = versionChapterData.versions[0].text[arrayIndex];
                        }
                        
                        if (versionText && versionText.trim()) {
                            versionText = versionText.replace(/<[^>]*>/g, '').trim();
                            
                            versions.push({
                                title: version.title,
                                language: version.language,
                                text: versionText
                            });
                        }
                        
                    } catch (error) {
                        this.log(`❌ שגיאה בטעינת גירסה ${version.title}: ${error.message}`, null, 'error');
                    }
                }

                return versions;
            }

            createProfessionalWordDocument(documentData) {
                let html = `
                <!DOCTYPE html>
                <html dir="rtl" lang="he">
                <head>
                    <meta charset="UTF-8">
                    <style>
                        @page {
                            margin: 2cm;
                            direction: rtl;
                        }
                        
                        body { 
                            font-family: 'David', 'Frank Ruhl Libre', 'Times New Roman', serif; 
                            direction: rtl; 
                            text-align: right;
                            line-height: 1.8;
                            margin: 0;
                            color: #333;
                            font-size: 16px;
                        }
                        
                        .document-header { 
                            text-align: center; 
                            margin-bottom: 40px;
                            padding-bottom: 20px;
                            border-bottom: 3px solid #18345d;
                        }
                        
                        .main-title { 
                            font-size: 28px; 
                            font-weight: bold; 
                            color: #18345d;
                            margin-bottom: 10px;
                        }
                        
                        .subtitle {
                            font-size: 16px;
                            color: #666;
                            margin-bottom: 15px;
                        }
                        
                        .meta-info {
                            font-size: 14px;
                            color: #888;
                            font-style: italic;
                        }
                        
                        .verse-container { 
                            margin-bottom: 35px; 
                            padding: 20px;
                            background: #fafafa;
                            border-right: 4px solid #18345d;
                            border-radius: 8px;
                            page-break-inside: avoid;
                        }
                        
                        .verse-header { 
                            font-size: 16px; 
                            font-weight: bold; 
                            color: #18345d;
                            margin-bottom: 15px;
                            padding-bottom: 8px;
                            border-bottom: 1px solid #ddd;
                        }
                        
                        .verse-text { 
                            font-size: 18px; 
                            font-weight: 600; 
                            margin-bottom: 20px;
                            line-height: 1.8;
                            color: #222;
                            background: white;
                            padding: 15px;
                            border-radius: 6px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }
                        
                        .verse-number {
                            display: inline-block;
                            background: #18345d;
                            color: white;
                            font-size: 14px;
                            font-weight: bold;
                            padding: 4px 8px;
                            border-radius: 50%;
                            margin-left: 10px;
                            min-width: 24px;
                            text-align: center;
                        }
                        
                        .versions-section {
                            margin-top: 20px;
                            padding-top: 15px;
                            border-top: 2px dashed #ddd;
                        }
                        
                        .version-item {
                            margin: 15px 0;
                            padding: 15px;
                            background: white;
                            border-right: 3px solid #3498db;
                            border-radius: 6px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        }
                        
                        .version-title {
                            font-weight: bold;
                            color: #3498db;
                            margin-bottom: 8px;
                            font-size: 15px;
                        }
                        
                        .version-text {
                            font-size: 16px;
                            color: #444;
                            line-height: 1.6;
                        }
                        
                        .commentaries-section {
                            margin-top: 20px;
                            padding-top: 15px;
                            border-top: 2px dashed #ddd;
                        }
                        
                        .commentary-item {
                            margin: 15px 0;
                            padding: 15px;
                            background: white;
                            border-right: 3px solid #8e44ad;
                            border-radius: 6px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        }
                        
                        .commentary-title { 
                            font-size: 15px; 
                            font-weight: bold; 
                            color: #8e44ad;
                            margin-bottom: 8px;
                        }
                        
                        .commentary-text { 
                            font-size: 15px; 
                            color: #555;
                            line-height: 1.6;
                        }
                        
                        .section-divider {
                            text-align: center;
                            margin: 30px 0;
                            color: #999;
                            font-size: 24px;
                        }
                        
                        .footer {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 2px solid #18345d;
                            text-align: center;
                            color: #666;
                            font-size: 14px;
                        }
                        
                        @media print {
                            .verse-container {
                                break-inside: avoid;
                            }
                            
                            body {
                                font-size: 14px;
                            }
                            
                            .main-title {
                                font-size: 24px;
                            }
                        }
                    </style>
                </head>
                <body>
                `;

                // כותרת המסמך
                let title = this.currentBook.heTitle || this.currentBook.title;
                if (this.currentSection) {
                    title += ` - ${this.currentSection.title}`;
                }
                title += ` פרק ${this.currentChapter}`;

                const start = documentData.length > 0 ? documentData[0].paragraphNum : '';
                const end = documentData.length > 0 ? documentData[documentData.length - 1].paragraphNum : '';
                const range = start && end ? (start === end ? `פסוק ${start}` : `פסוקים ${start}-${end}`) : '';

                html += `
                <div class="document-header">
                    <div class="main-title">${title}</div>
                    <div class="subtitle">${range}</div>
                    <div class="meta-info">נוצר באמצעות ניווט ספריא • ${new Date().toLocaleDateString('he-IL')}</div>
                </div>
                `;

                // תוכן הפסוקים
                documentData.forEach((verse, index) => {
                    html += `
                    <div class="verse-container">
                        <div class="verse-header">
                            <span class="verse-number">${verse.paragraphNum}</span>
                            ${verse.ref}
                        </div>
                        <div class="verse-text">${verse.hebrewText}</div>
                    `;

                    // גירסאות נוספות
                    if (verse.additionalVersions && verse.additionalVersions.length > 0) {
                        html += `<div class="versions-section">`;
                        verse.additionalVersions.forEach(version => {
                            html += `
                            <div class="version-item">
                                <div class="version-title">${version.title} (${version.language})</div>
                                <div class="version-text">${version.text}</div>
                            </div>
                            `;
                        });
                        html += `</div>`;
                    }

                    // מפרשים
                    if (verse.commentaries && verse.commentaries.length > 0) {
                        html += `<div class="commentaries-section">`;
                        verse.commentaries.forEach(commentary => {
                            html += `
                            <div class="commentary-item">
                                <div class="commentary-title">${commentary.title}</div>
                                <div class="commentary-text">${commentary.text}</div>
                            </div>
                            `;
                        });
                        html += `</div>`;
                    }

                    html += `</div>`;

                    // מפריד בין פסוקים
                    if (index < documentData.length - 1) {
                        html += `<div class="section-divider">◆</div>`;
                    }
                });

                // כותרת תחתונה
                html += `
                <div class="footer">
                    <p>מסמך זה נוצר באמצעות ניווט ספריא</p>
                    <p>מקור: ספריא (sefaria.org) • ${documentData.length} פסוקים</p>
                </div>
                `;

                html += `</body></html>`;

                // הורדת הקובץ
                const blob = new Blob([html], { 
                    type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // יצירת שם קובץ נקי
                const cleanTitle = title.replace(/[^\u0590-\u05FF\w\s-]/g, '').trim();
                a.download = `${cleanTitle}.doc`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.log(`📄 מסמך הורד: ${cleanTitle}.doc`);
            }

            // פונקציות ניווט
            goBack() {
                if (this.currentPath.length > 0) {
                    this.currentPath.pop();
                    if (this.currentPath.length === 0) {
                        this.loadCategories();
                    } else {
                        const parent = this.currentPath[this.currentPath.length - 1];
                        this.navigateToCategory(parent);
                        this.currentPath.pop();
                    }
                    this.updateBreadcrumb();
                    this.updateBackButton();
                }
            }

            goHome() {
                this.currentPath = [];
                this.currentBook = null;
                this.currentSection = null;
                this.currentSubSection = null; // איפוס רמת תת-חלק
                this.currentChapter = null;

                // הסר ממשק מילון אם קיים
                const dictionaryStep = document.getElementById('dictionaryStep');
                if (dictionaryStep) {
                    dictionaryStep.remove();
                }

                document.getElementById('categoriesStep').classList.remove('hidden');
                document.getElementById('sectionStep').classList.add('hidden');
                document.getElementById('chapterStep').classList.add('hidden');
                document.getElementById('paragraphStep').classList.add('hidden');

                this.loadCategories();
                this.updateBreadcrumb();
                this.updateBackButton();

                this.log('🏠 חזרה לדף הבית');
            }

            backToBook() {
                this.currentSection = null;
                this.currentSubSection = null; // איפוס רמת תת-חלק

                document.getElementById('sectionStep').classList.add('hidden');
                document.getElementById('chapterStep').classList.add('hidden');
                document.getElementById('paragraphStep').classList.add('hidden');
                document.getElementById('categoriesStep').classList.remove('hidden');

                this.log('📖 חזרה לבחירת ספר');
            }

            backToSection() {
                this.currentSubSection = null; // איפוס רמת תת-חלק
                
                document.getElementById('chapterStep').classList.add('hidden');
                document.getElementById('paragraphStep').classList.add('hidden');
                document.getElementById('sectionStep').classList.remove('hidden');

                this.log('📑 חזרה לבחירת חלק');
            }

            backToChapter() {
                // לא מאפס currentSubSection כי אולי נחזור לאותו תת-חלק
                document.getElementById('paragraphStep').classList.add('hidden');
                document.getElementById('chapterStep').classList.remove('hidden');

                this.log('🔢 חזרה לבחירת פרק');
            }

            updateBreadcrumb() {
                const breadcrumb = document.getElementById('breadcrumb');
                let path = '📍 דף הבית';

                this.currentPath.forEach(item => {
                    if (item.category) {
                        path += ` > ${item.heCategory || item.category}`;
                    } else if (item.title) {
                        path += ` > ${item.heTitle || item.title}`;
                    }
                });

                breadcrumb.textContent = path;
            }

            updateBackButton() {
                document.getElementById('backBtn').disabled = this.currentPath.length === 0;
            }

            // פונקציות עזר
            log(message, data = null, type = 'info') {
                const debugPanel = document.getElementById('debugPanel');
                const timestamp = new Date().toLocaleTimeString('he-IL');

                let logEntry = `[${timestamp}] ${message}`;
                if (data) {
                    logEntry += '\n' + JSON.stringify(data, null, 2);
                }

                const logDiv = document.createElement('div');
                logDiv.style.color = type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#3498db';
                logDiv.style.marginBottom = '5px';
                logDiv.style.borderBottom = '1px solid #444';
                logDiv.style.paddingBottom = '3px';
                logDiv.textContent = logEntry;

                debugPanel.appendChild(logDiv);
                debugPanel.scrollTop = debugPanel.scrollHeight;

                // הגבל את מספר ההודעות בלוג
                while (debugPanel.children.length > 100) {
                    debugPanel.removeChild(debugPanel.firstChild);
                }

                console.log(message, data);
            }

            clearDebug() {
                const debugPanel = document.getElementById('debugPanel');
                debugPanel.innerHTML = '<div>📱 לוג נוקה • סטטיסטיקות API:</div>';
                
                // הצג סטטיסטיקות API
                const statsDiv = document.createElement('div');
                statsDiv.style.color = '#3498db';
                statsDiv.style.margin = '10px 0';
                statsDiv.innerHTML = `
                    📊 סה"כ קריאות: ${this.apiStats.totalCalls}<br>
                    ✅ הצליחו: ${this.apiStats.successCalls}<br>
                    ❌ נכשלו: ${this.apiStats.failedCalls}<br>
                    📋 שימוש במטמון: ${this.apiStats.cacheHits}
                `;
                debugPanel.appendChild(statsDiv);
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `
                    <strong>❌ שגיאה:</strong> ${message}
                    <br><small>בדוק את הלוג למידע נוסף</small>
                `;
                document.body.appendChild(errorDiv);

                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 7000);
            }

            showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.innerHTML = `
                    <strong>✅ הצלחה:</strong> ${message}
                `;
                document.body.appendChild(successDiv);

                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 5000);
            }
        }

        // התחלת האפליקציה
        document.addEventListener('DOMContentLoaded', () => {
            new SefariaNavigator();
        });
    </script>
</body>

</html>